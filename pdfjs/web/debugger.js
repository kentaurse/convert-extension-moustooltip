let opMap;const FontInspector=function(){let e,t=!1;const n="data-font-name";function o(){const e=document.querySelectorAll(`span[${n}]`);for(const t of e)t.className="debuggerHideText"}function a(e,t){const o=document.querySelectorAll(`span[${n}=${e}]`);for(const e of o)e.className=t?"debuggerShowText":"debuggerHideText"}function s(e){if(!e.target.dataset.fontName||"SPAN"!==e.target.tagName.toUpperCase())return;const t=e.target.dataset.fontName,n=document.getElementsByTagName("input");for(const e of n)e.dataset.fontName===t&&(e.checked=!e.checked,a(t,e.checked),e.scrollIntoView())}return{id:"FontInspector",name:"Font Inspector",panel:null,manager:null,init(t){const n=this.panel,a=document.createElement("button");a.addEventListener("click",o),a.textContent="Refresh",n.append(a),e=document.createElement("div"),n.append(e)},cleanup(){e.textContent=""},enabled:!1,get active(){return t},set active(e){t=e,t?(document.body.addEventListener("click",s,!0),o()):(document.body.removeEventListener("click",s,!0),function(){const e=document.querySelectorAll(`span[${n}]`);for(const t of e)t.className=""}())},fontAdded(t,n){const s=function(e,t){const n=document.createElement("table");for(const t of["name","type"]){const o=document.createElement("tr"),a=document.createElement("td");a.textContent=t,o.append(a);const s=document.createElement("td");s.textContent=e[t].toString(),o.append(s),n.append(o)}return n}(t),r=t.loadedName,c=document.createElement("div"),i=document.createElement("span");i.textContent=r;const d=document.createElement("a");n?(n=/url\(['"]?([^)"']+)/.exec(n),d.href=n[1]):t.data&&(d.href=URL.createObjectURL(new Blob([t.data],{type:t.mimetype}))),d.textContent="Download";const l=document.createElement("a");l.href="",l.textContent="Log",l.addEventListener("click",(function(e){e.preventDefault(),console.log(t)}));const p=document.createElement("input");p.setAttribute("type","checkbox"),p.dataset.fontName=r,p.addEventListener("click",(function(){a(r,p.checked)})),c.append(p,i," ",d," ",l,s),e.append(c),setTimeout((()=>{this.active&&o()}),2e3)}}}(),StepperManager=function(){let e=[],t=null,n=null,o=null,a=Object.create(null);return{id:"Stepper",name:"Stepper",panel:null,manager:null,init(e){const s=this;n=document.createElement("div"),o=document.createElement("select"),o.addEventListener("change",(function(e){s.selectStepper(this.value)})),n.append(o),t=document.createElement("div"),this.panel.append(n,t),sessionStorage.getItem("pdfjsBreakPoints")&&(a=JSON.parse(sessionStorage.getItem("pdfjsBreakPoints"))),opMap=Object.create(null);for(const t in e.OPS)opMap[e.OPS[t]]=t},cleanup(){o.textContent="",t.textContent="",e=[]},enabled:!1,active:!1,create(n){const s=document.createElement("div");s.id="stepper"+n,s.hidden=!0,s.className="stepper",t.append(s);const r=document.createElement("option");r.textContent="Page "+(n+1),r.value=n,o.append(r);const c=a[n]||[],i=new Stepper(s,n,c);return e.push(i),1===e.length&&this.selectStepper(n,!1),i},selectStepper(t,n){t|=0,n&&this.manager.selectPanel(this);for(const n of e)n.panel.hidden=n.pageIndex!==t;for(const e of o.options)e.selected=(0|e.value)===t},saveBreakPoints(e,t){a[e]=t,sessionStorage.setItem("pdfjsBreakPoints",JSON.stringify(a))}}}(),Stepper=function(){function e(e,t){const n=document.createElement(e);return t&&(n.textContent=t),n}function t(e){if("string"==typeof e){const t=75;return e.length<=t?e:e.substring(0,t)+"..."}if("object"!=typeof e||null===e)return e;if("length"in e){const n=10,o=[];let a,s;for(a=0,s=Math.min(n,e.length);a<s;a++)o.push(t(e[a]));return a<e.length&&o.push("..."),o}const n={};for(const o in e)n[o]=t(e[o]);return n}return class{constructor(e,t,n){this.panel=e,this.breakPoint=0,this.nextBreakPoint=null,this.pageIndex=t,this.breakPoints=n,this.currentIdx=-1,this.operatorListIdx=0,this.indentLevel=0}init(t){const n=this.panel,o=e("div","c=continue, s=step"),a=e("table");o.append(a),a.cellSpacing=0;const s=e("tr");a.append(s),s.append(e("th","Break"),e("th","Idx"),e("th","fn"),e("th","args")),n.append(o),this.table=a,this.updateOperatorList(t)}updateOperatorList(n){const o=this;function a(){const e=+this.dataset.idx;this.checked?o.breakPoints.push(e):o.breakPoints.splice(o.breakPoints.indexOf(e),1),StepperManager.saveBreakPoints(o.pageIndex,o.breakPoints)}if(this.operatorListIdx>15e3)return;const s=document.createDocumentFragment(),r=Math.min(15e3,n.fnArray.length);for(let o=this.operatorListIdx;o<r;o++){const r=e("tr");r.className="line",r.dataset.idx=o,s.append(r);const c=this.breakPoints.includes(o),i=n.argsArray[o]||[],d=e("td"),l=e("input");l.type="checkbox",l.className="points",l.checked=c,l.dataset.idx=o,l.onclick=a,d.append(l),r.append(d,e("td",o.toString()));const p=opMap[n.fnArray[o]];let u=i;if("showText"===p){const t=i[0],n=e("tr"),o=e("tr"),a=e("tr");for(const s of t)if("object"==typeof s&&null!==s)n.append(e("td",s.originalCharCode)),o.append(e("td",s.fontChar)),a.append(e("td",s.unicode));else{const t=e("td",s);t.classList.add("advance"),n.append(t),o.append(e("td")),a.append(e("td"))}u=e("td");const s=e("table");s.classList.add("showText"),u.append(s),s.append(n,o,a)}else"restore"===p&&this.indentLevel>0&&this.indentLevel--;r.append(e("td"," ".repeat(2*this.indentLevel)+p)),"save"===p&&this.indentLevel++,u instanceof HTMLElement?r.append(u):r.append(e("td",JSON.stringify(t(u))))}if(r<n.fnArray.length){const t=e("td","...");t.colspan=4,s.append(t)}this.operatorListIdx=n.fnArray.length,this.table.append(s)}getNextBreakPoint(){this.breakPoints.sort((function(e,t){return e-t}));for(const e of this.breakPoints)if(e>this.currentIdx)return e;return null}breakIt(e,t){StepperManager.selectStepper(this.pageIndex,!0),this.currentIdx=e;const n=e=>{switch(e.keyCode){case 83:document.removeEventListener("keydown",n),this.nextBreakPoint=this.currentIdx+1,this.goTo(-1),t();break;case 67:document.removeEventListener("keydown",n),this.nextBreakPoint=this.getNextBreakPoint(),this.goTo(-1),t()}};document.addEventListener("keydown",n),this.goTo(e)}goTo(e){const t=this.panel.getElementsByClassName("line");for(const n of t)(0|n.dataset.idx)===e?(n.style.backgroundColor="rgb(251,250,207)",n.scrollIntoView()):n.style.backgroundColor=null}}}(),Stats=function(){let e=[];function t(e){e.textContent=""}return{id:"Stats",name:"Stats",panel:null,manager:null,init(e){},enabled:!1,active:!1,add(n,o){if(!o)return;const a=function(t){for(const[n,o]of e.entries())if(o.pageNumber===t)return n;return!1}(n);!1!==a&&(e[a].div.remove(),e.splice(a,1));const s=document.createElement("div");s.className="stats";const r=document.createElement("div");r.className="title",r.textContent="Page: "+n;const c=document.createElement("div");c.textContent=o.toString(),s.append(r,c),e.push({pageNumber:n,div:s}),e.sort((function(e,t){return e.pageNumber-t.pageNumber})),t(this.panel);for(const t of e)this.panel.append(t.div)},cleanup(){e=[],t(this.panel)}}}(),PDFBug=function(){const e=[];let t=null;return{tools:[FontInspector,StepperManager,Stats],enable(e){const t=1===e.length&&"all"===e[0],n=this.tools;for(const o of n)(t||e.includes(o.id))&&(o.enabled=!0);t||n.sort((function(t,o){let a=e.indexOf(t.id);a=a<0?n.length:a;let s=e.indexOf(o.id);return s=s<0?n.length:s,a-s}))},init(t,n,o){this.loadCSS(),this.enable(o);const a=document.createElement("div");a.id="PDFBug";const s=document.createElement("div");s.setAttribute("class","controls"),a.append(s);const r=document.createElement("div");r.setAttribute("class","panels"),a.append(r),n.append(a),n.style.right="300px";for(const n of this.tools){const o=document.createElement("div"),a=document.createElement("button");a.textContent=n.name,a.addEventListener("click",(e=>{e.preventDefault(),this.selectPanel(n)})),s.append(a),r.append(o),n.panel=o,n.manager=this,n.enabled?n.init(t):o.textContent=`${n.name} is disabled. To enable add "${n.id}" to the pdfBug parameter and refresh (separate multiple by commas).`,e.push(a)}this.selectPanel(0)},loadCSS(){const{url:e}=import.meta,t=document.createElement("link");t.rel="stylesheet",t.href=e.replace(/.js$/,".css"),document.head.append(t)},cleanup(){for(const e of this.tools)e.enabled&&e.cleanup()},selectPanel(n){if("number"!=typeof n&&(n=this.tools.indexOf(n)),n!==t){t=n;for(const[t,o]of this.tools.entries()){const a=t===n;e[t].classList.toggle("active",a),o.active=a,o.panel.hidden=!a}}}}}();globalThis.FontInspector=FontInspector,globalThis.StepperManager=StepperManager,globalThis.Stats=Stats;export{PDFBug};