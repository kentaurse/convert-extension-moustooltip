import*as CFI from"./epubcfi.js";const NS={CONTAINER:"urn:oasis:names:tc:opendocument:xmlns:container",XHTML:"http://www.w3.org/1999/xhtml",OPF:"http://www.idpf.org/2007/opf",EPUB:"http://www.idpf.org/2007/ops",DC:"http://purl.org/dc/elements/1.1/",DCTERMS:"http://purl.org/dc/terms/",ENC:"http://www.w3.org/2001/04/xmlenc#",NCX:"http://www.daisy.org/z3986/2005/ncx/",XLINK:"http://www.w3.org/1999/xlink",SMIL:"http://www.w3.org/ns/SMIL"},MIME={XML:"application/xml",NCX:"application/x-dtbncx+xml",XHTML:"application/xhtml+xml",HTML:"text/html",CSS:"text/css",SVG:"image/svg+xml",JS:/\/(x-)?(javascript|ecmascript)/},camel=e=>e.toLowerCase().replace(/[-:](.)/g,((e,t)=>t.toUpperCase())),normalizeWhitespace=e=>e?e.replace(/[\t\n\f\r ]+/g," ").replace(/^[\t\n\f\r ]+/,"").replace(/[\t\n\f\r ]+$/,""):"",filterAttribute=(e,t,r)=>r?r=>r.getAttribute(e)?.split(/\s/)?.includes(t):"function"==typeof t?r=>t(r.getAttribute(e)):r=>r.getAttribute(e)===t,getAttributes=(...e)=>t=>t?Object.fromEntries(e.map((e=>[camel(e),t.getAttribute(e)]))):null,getElementText=e=>{return t=e?.textContent,t?t.replace(/[\t\n\f\r ]+/g," ").replace(/^[\t\n\f\r ]+/,"").replace(/[\t\n\f\r ]+$/,""):"";var t},childGetter=(e,t)=>{const r=e.lookupNamespaceURI(null)===t||e.lookupPrefix(t),i=r?(e,r)=>e=>e.namespaceURI===t&&e.localName===r:(e,t)=>e=>e.localName===t;return{$:(e,t)=>[...e.children].find(i(e,t)),$$:(e,t)=>[...e.children].filter(i(e,t)),$$$:r?(e,r)=>[...e.getElementsByTagNameNS(t,r)]:(e,r)=>[...e.getElementsByTagName(t,r)]}},resolveURL=(e,t)=>{try{if(t.includes(":"))return new URL(e,t);const r="https://invalid.invalid/";return decodeURI(new URL(e,r+t).href.replace(r,""))}catch(t){return console.warn(t),e}},isExternal=e=>/^(?!blob)\w+:/i.test(e),pathRelative=(e,t)=>{if(!e)return t;const r=e.replace(/\/$/,"").split("/"),i=t.replace(/\/$/,"").split("/"),a=(r.length>i.length?r:i).findIndex(((e,t)=>r[t]!==i[t]));return a<0?"":Array(r.length-a).fill("..").concat(i.slice(a)).join("/")},pathDirname=e=>e.slice(0,e.lastIndexOf("/")+1),replaceSeries=async(e,t,r)=>{const i=[];e.replace(t,((...e)=>(i.push(e),null)));const a=[];for(const e of i)a.push(await r(...e));return e.replace(t,(()=>a.shift()))},regexEscape=e=>e.replace(/[-/\\^$*+?.()|[\]{}]/g,"\\$&"),LANGS={attrs:["dir","xml:lang"]},ALTS={name:"alternate-script",many:!0,...LANGS,props:["file-as"]},CONTRIB={many:!0,...LANGS,props:[{name:"role",many:!0,attrs:["scheme"]},"file-as",ALTS]},METADATA=[{name:"title",many:!0,...LANGS,props:["title-type","display-seq","file-as",ALTS]},{name:"identifier",many:!0,props:[{name:"identifier-type",attrs:["scheme"]}]},{name:"language",many:!0},{name:"creator",...CONTRIB},{name:"contributor",...CONTRIB},{name:"publisher",...LANGS,props:["file-as",ALTS]},{name:"description",...LANGS,props:[ALTS]},{name:"rights",...LANGS,props:[ALTS]},{name:"date"},{name:"dcterms:modified",type:"meta"},{name:"subject",many:!0,...LANGS,props:["term","authority",ALTS]},{name:"belongs-to-collection",type:"meta",many:!0,...LANGS,props:["collection-type","group-position","dcterms:identifier","file-as",ALTS,{name:"belongs-to-collection",recursive:!0}]}],getMetadata=e=>{const{$:t,$$:r}=childGetter(e,NS.OPF),i=t(e.documentElement,"metadata"),a=Array.from(i.children),s=(e,t)=>{if(!t)return null;const{props:r=[],attrs:i=[]}=e,n=getElementText(t);if(!r.length&&!i.length)return n;const o=t.getAttribute("id"),l=o?a.filter(filterAttribute("refines","#"+o)):[];return Object.fromEntries([["value",n]].concat(r.map((t=>{const{many:r,recursive:i}=t,a="string"==typeof t?t:t.name,n=filterAttribute("property",a),o=i?e:t;return[camel(a),r?l.filter(n).map((e=>s(o,e))):s(o,l.find(n))]}))).concat(i.map((e=>[camel(e),t.getAttribute(e)]))))},n=a.filter(filterAttribute("refines",null)),o=e=>Object.fromEntries(r(i,"meta").filter(filterAttribute("property",(t=>t?.startsWith(e)))).map((t=>[t.getAttribute("property").replace(e,""),getElementText(t)])));return{metadata:Object.fromEntries(METADATA.map((e=>{const{type:t,name:r,many:i}=e,a="meta"===t?e=>e.namespaceURI===NS.OPF&&e.getAttribute("property")===r:e=>e.namespaceURI===NS.DC&&e.localName===r;return[camel(r),i?n.filter(a).map((t=>s(e,t))):s(e,n.find(a))]}))),rendition:o("rendition:"),media:o("media:")}},parseNav=(e,t=(e=>e))=>{const{$:r,$$:i,$$$:a}=childGetter(e,NS.XHTML),s=(e,a)=>e?i(e,"li").map((e=>i=>{const a=r(i,"a")??r(i,"span"),n=r(i,"ol"),o=(e=>e?decodeURI(t(e)):null)(a?.getAttribute("href")),l={label:getElementText(a)||a?.getAttribute("title"),href:o,subitems:s(n)};return e&&(l.type=a?.getAttributeNS(NS.EPUB,"type")?.split(/\s/)),l})(a)):null,n=(e,t)=>s(r(e,"ol"),t),o=a(e,"nav");let l=null,c=null,p=null,d=[];for(const e of o){const t=e.getAttributeNS(NS.EPUB,"type")?.split(/\s/)??[];t.includes("toc")?l??=n(e):t.includes("page-list")?c??=n(e):t.includes("landmarks")?p??=n(e,!0):d.push({label:getElementText(e.firstElementChild),type:t,list:n(e)})}return{toc:l,pageList:c,landmarks:p,others:d}},parseNCX=(e,t=(e=>e))=>{const{$:r,$$:i}=childGetter(e,NS.NCX),a=e=>{const s=r(e,"navLabel"),n=r(e,"content"),o=getElementText(s),l=(e=>e?decodeURI(t(e)):null)(n.getAttribute("src"));if("navPoint"===e.localName){const t=i(e,"navPoint");return{label:o,href:l,subitems:t.length?t.map(a):null}}return{label:o,href:l}},s=(e,t)=>i(e,t).map(a),n=(t,i)=>{const a=r(e.documentElement,t);return a?s(a,i):null};return{toc:n("navMap","navPoint"),pageList:n("pageList","pageTarget"),others:i(e.documentElement,"navList").map((e=>({label:getElementText(r(e,"navLabel")),list:s(e,"navTarget")})))}},parseClock=e=>{if(!e)return;const t=e.split(":").map((e=>parseFloat(e)));if(3===t.length){const[e,r,i]=t;return 60*e*60+60*r+i}if(2===t.length){const[e,r]=t;return 60*e+r}const[r,i]=e.split(/(?=[^\d.])/);return parseFloat(r)*("h"===i?3600:"min"===i?60:"ms"===i?.001:1)},parseSMIL=(e,t=(e=>e))=>{const{$:r,$$$:i}=childGetter(e,NS.SMIL);return i(e,"par").map((e=>{const i=r(e,"text")?.getAttribute("src")?.split("#")?.[1],a=r(e,"audio");return a?{id:i,audio:{src:(s=a.getAttribute("src"),s?decodeURI(t(s)):null),clipBegin:parseClock(a.getAttribute("clipBegin")),clipEnd:parseClock(a.getAttribute("clipEnd"))}}:{id:i};var s}))},isUUID=/([0-9a-f]{8})-([0-9a-f]{4})-([0-9a-f]{4})-([0-9a-f]{4})-([0-9a-f]{12})/,getUUID=e=>{for(const t of e.getElementsByTagNameNS(NS.DC,"identifier")){const[e]=getElementText(t).split(":").slice(-1);if(isUUID.test(e))return e}return""},getIdentifier=e=>getElementText(e.getElementById(e.documentElement.getAttribute("unique-identifier"))??e.getElementsByTagNameNS(NS.DC,"identifier")[0]),deobfuscate=async(e,t,r)=>{const i=new Uint8Array(await r.slice(0,t).arrayBuffer());t=Math.min(t,i.length);for(var a=0;a<t;a++)i[a]=i[a]^e[a%e.length];return new Blob([i,r.slice(t)],{type:r.type})},WebCryptoSHA1=async e=>{const t=(new TextEncoder).encode(e),r=await globalThis.crypto.subtle.digest("SHA-1",t);return new Uint8Array(r)},deobfuscators=(e=WebCryptoSHA1)=>({"http://www.idpf.org/2008/embedding":{key:t=>e(getIdentifier(t).replaceAll(/[\u0020\u0009\u000d\u000a]/g,"")),decode:(e,t)=>deobfuscate(e,1040,t)},"http://ns.adobe.com/pdf/enc#RC":{key:e=>{const t=getUUID(e).replaceAll("-","");return Uint8Array.from({length:16},((e,r)=>parseInt(t.slice(2*r,2*r+2),16)))},decode:(e,t)=>deobfuscate(e,1024,t)}});class Encryption{#e=new Map;#t=new Map;#r;constructor(e){this.#r=e}async init(e,t){if(!e)return;const r=Array.from(e.getElementsByTagNameNS(NS.ENC,"EncryptedData"),(e=>({algorithm:e.getElementsByTagNameNS(NS.ENC,"EncryptionMethod")[0]?.getAttribute("Algorithm"),uri:e.getElementsByTagNameNS(NS.ENC,"CipherReference")[0]?.getAttribute("URI")})));for(const{algorithm:e,uri:i}of r){if(!this.#t.has(e)){const r=this.#r[e];if(!r){console.warn("Unknown encryption algorithm");continue}const i=await r.key(t);this.#t.set(e,(e=>r.decode(i,e)))}this.#e.set(i,e)}}getDecoder(e){return this.#t.get(this.#e.get(e))??(e=>e)}}class Resources{constructor({opf:e,resolveHref:t}){this.opf=e;const{$:r,$$:i,$$$:a}=childGetter(e,NS.OPF),s=r(e.documentElement,"manifest"),n=r(e.documentElement,"spine"),o=i(n,"itemref");this.manifest=i(s,"item").map(getAttributes("href","id","media-type","properties","media-overlay")).map((e=>(e.href=t(e.href),e.properties=e.properties?.split(/\s/),e))),this.spine=o.map(getAttributes("idref","id","linear","properties")).map((e=>(e.properties=e.properties?.split(/\s/),e))),this.pageProgressionDirection=n.getAttribute("page-progression-direction"),this.navPath=this.getItemByProperty("nav")?.href,this.ncxPath=(this.getItemByID(n.getAttribute("toc"))??this.manifest.find((e=>e.mediaType===MIME.NCX)))?.href;const l=r(e.documentElement,"guide");l&&(this.guide=i(l,"reference").map(getAttributes("type","title","href")).map((({type:e,title:r,href:i})=>({label:r,type:e.split(/\s/),href:t(i)})))),this.cover=this.getItemByProperty("cover-image")??this.getItemByID(a(e,"meta").find(filterAttribute("name","cover"))?.getAttribute("content"))??this.getItemByHref(this.guide?.find((e=>e.type.includes("cover")))?.href),this.cfis=CFI.fromElements(o)}getItemByID(e){return this.manifest.find((t=>t.id===e))}getItemByHref(e){return this.manifest.find((t=>t.href===e))}getItemByProperty(e){return this.manifest.find((t=>t.properties?.includes(e)))}resolveCFI(e){const t=CFI.parse(e),r=(t.parent??t).shift();let i=CFI.toElement(this.opf,r);i&&"idref"!==i.nodeName&&(r.at(-1).id=null,i=CFI.toElement(this.opf,r));const a=i?.getAttribute("idref");return{index:this.spine.findIndex((e=>e.idref===a)),anchor:e=>CFI.toRange(e,t)}}}class Loader{#i=new Map;#a=new Map;#s=new Map;allowScript=!1;constructor({loadText:e,loadBlob:t,resources:r}){this.loadText=e,this.loadBlob=t,this.manifest=r.manifest,this.assets=r.manifest}createURL(e,t,r,i){if(!t)return"";const a=URL.createObjectURL(new Blob([t],{type:r}));if(this.#i.set(e,a),this.#s.set(e,1),i){const t=this.#a.get(i);t?t.push(e):this.#a.set(i,[e])}return a}ref(e,t){const r=this.#a.get(t);return r?.includes(e)||(this.#s.set(e,this.#s.get(e)+1),r?r.push(e):this.#a.set(t,[e])),this.#i.get(e)}unref(e){if(!this.#s.has(e))return;const t=this.#s.get(e)-1;if(t<1){URL.revokeObjectURL(this.#i.get(e)),this.#i.delete(e),this.#s.delete(e);const t=this.#a.get(e);if(t)for(;t.length;)this.unref(t.pop());this.#a.delete(e)}else this.#s.set(e,t)}async loadItem(e,t=[]){if(!e)return null;const{href:r,mediaType:i}=e,a=MIME.JS.test(e.mediaType);if(a&&!this.allowScript)return null;const s=t.at(-1);return this.#i.has(r)?this.ref(r,s):(a||[MIME.XHTML,MIME.HTML,MIME.CSS,MIME.SVG].includes(i))&&t.every((e=>e!==r))?this.loadReplaced(e,t):this.createURL(r,await this.loadBlob(r),i,s)}async loadHref(e,t,r=[]){if(isExternal(e))return e;const i=resolveURL(e,t),a=this.manifest.find((e=>e.href===i));return a?this.loadItem(a,r.concat(t)):e}async loadReplaced(e,t=[]){const{href:r,mediaType:i}=e,a=t.at(-1),s=await this.loadText(r);if(!s)return null;if([MIME.XHTML,MIME.HTML,MIME.SVG].includes(i)){let n=(new DOMParser).parseFromString(s,i);if(i===MIME.XHTML&&n.querySelector("parsererror")&&(console.warn(n.querySelector("parsererror").innerText),e.mediaType=MIME.HTML,n=(new DOMParser).parseFromString(s,e.mediaType)),[MIME.XHTML,MIME.SVG].includes(e.mediaType)){let e=n.firstChild;for(;e instanceof ProcessingInstruction;){if(e.data){const i=await replaceSeries(e.data,/(?:^|\s*)(href\s*=\s*['"])([^'"]*)(['"])/i,((e,i,a,s)=>this.loadHref(a,r,t).then((e=>`${i}${e}${s}`))));e.replaceWith(n.createProcessingInstruction(e.target,i))}e=e.nextSibling}}const o=async(e,i)=>e.setAttribute(i,await this.loadHref(e.getAttribute(i),r,t));for(const e of n.querySelectorAll("link[href]"))await o(e,"href");for(const e of n.querySelectorAll("[src]"))await o(e,"src");for(const e of n.querySelectorAll("[poster]"))await o(e,"poster");for(const e of n.querySelectorAll("object[data]"))await o(e,"data");for(const e of n.querySelectorAll("[*|href]:not([href]"))e.setAttributeNS(NS.XLINK,"href",await this.loadHref(e.getAttributeNS(NS.XLINK,"href"),r,t));for(const e of n.querySelectorAll("style"))e.textContent&&(e.textContent=await this.replaceCSS(e.textContent,r,t));for(const e of n.querySelectorAll("[style]"))e.setAttribute("style",await this.replaceCSS(e.getAttribute("style"),r,t));const l=(new XMLSerializer).serializeToString(n);return this.createURL(r,l,e.mediaType,a)}const n=i===MIME.CSS?await this.replaceCSS(s,r,t):await this.replaceString(s,r,t);return this.createURL(r,n,i,a)}async replaceCSS(e,t,r=[]){const i=await replaceSeries(e,/url\(\s*["']?([^'"\n]*?)\s*["']?\s*\)/gi,((e,i)=>this.loadHref(i,t,r).then((e=>`url("${e}")`)))),a=await replaceSeries(i,/@import\s*["']([^"'\n]*?)["']/gi,((e,i)=>this.loadHref(i,t,r).then((e=>`@import "${e}"`)))),s=window?.innerWidth??800,n=window?.innerHeight??600;return a.replace(/-epub-/gi,"").replace(/(\d*\.?\d+)vw/gi,((e,t)=>parseFloat(t)*s/100+"px")).replace(/(\d*\.?\d+)vh/gi,((e,t)=>parseFloat(t)*n/100+"px")).replace(/page-break-(after|before|inside)/gi,((e,t)=>`-webkit-column-break-${t}`))}replaceString(e,t,r=[]){const i=new Map,a=this.assets.map((e=>{if(e.href===t)return;const r=pathRelative(pathDirname(t),e.href),a=encodeURI(r),s="/"+e.href,n=encodeURI(s),o=new Set([r,a,s,n]);for(const t of o)i.set(t,e);return Array.from(o)})).flat().filter((e=>e));if(!a.length)return e;const s=new RegExp(a.map(regexEscape).join("|"),"g");return replaceSeries(e,s,(async e=>this.loadItem(i.get(e.replace(/^\//,"")),r.concat(t))))}unloadItem(e){this.unref(e?.href)}destroy(){for(const e of this.#i.values())URL.revokeObjectURL(e)}}const getHTMLFragment=(e,t)=>e.getElementById(t)??e.querySelector(`[name="${CSS.escape(t)}"]`),getPageSpread=e=>{for(const t of e){if("page-spread-left"===t||"rendition:page-spread-left"===t)return"left";if("page-spread-right"===t||"rendition:page-spread-right"===t)return"right";if("rendition:page-spread-center"===t)return"center"}};export class EPUB{parser=new DOMParser;#n;#o;constructor({loadText:e,loadBlob:t,getSize:r,sha1:i}){this.loadText=e,this.loadBlob=t,this.getSize=r,this.#o=new Encryption(deobfuscators(i))}async#l(e){const t=await this.loadText(e);if(!t)return null;const r=this.parser.parseFromString(t,MIME.XML);if(r.querySelector("parsererror"))throw new Error(`XML parsing error: ${e}\n${r.querySelector("parsererror").innerText}`);return r}async init(){const e=await this.#l("META-INF/container.xml");if(!e)throw new Error("Failed to load container file");const t=Array.from(e.getElementsByTagNameNS(NS.CONTAINER,"rootfile"),getAttributes("full-path","media-type")).filter((e=>"application/oebps-package+xml"===e.mediaType));if(!t.length)throw new Error("No package document defined in container");const r=t[0].fullPath,i=await this.#l(r);if(!i)throw new Error("Failed to load package document");const a=await this.#l("META-INF/encryption.xml");await this.#o.init(a,i),this.resources=new Resources({opf:i,resolveHref:e=>resolveURL(e,r)}),this.#n=new Loader({loadText:this.loadText,loadBlob:e=>Promise.resolve(this.loadBlob(e)).then(this.#o.getDecoder(e)),resources:this.resources}),this.sections=this.resources.spine.map(((e,t)=>{const{idref:r,linear:i,properties:a=[]}=e,s=this.resources.getItemByID(r);return s?{id:this.resources.getItemByID(r)?.href,load:()=>this.#n.loadItem(s),unload:()=>this.#n.unloadItem(s),createDocument:()=>this.loadDocument(s),size:this.getSize(s.href),cfi:this.resources.cfis[t],linear:i,pageSpread:getPageSpread(a),resolveHref:e=>resolveURL(e,s.href),loadMediaOverlay:()=>this.loadMediaOverlay(s)}:(console.warn(`Could not find item with ID "${r}" in manifest`),null)})).filter((e=>e));const{navPath:s,ncxPath:n}=this.resources;if(s)try{const e=e=>resolveURL(e,s),t=parseNav(await this.#l(s),e);this.toc=t.toc,this.pageList=t.pageList,this.landmarks=t.landmarks}catch(e){console.warn(e)}if(!this.toc&&n)try{const e=e=>resolveURL(e,n),t=parseNCX(await this.#l(n),e);this.toc=t.toc,this.pageList=t.pageList}catch(e){console.warn(e)}this.landmarks??=this.resources.guide;const{metadata:o,rendition:l,media:c}=getMetadata(i);this.rendition=l,this.media=c,c.duration=parseClock(c.duration),this.dir=this.resources.pageProgressionDirection,this.rawMetadata=o;const p=o?.title?.[0];this.metadata={title:p?.value,subtitle:o?.title?.find((e=>"subtitle"===e.titleType))?.value,sortAs:p?.fileAs,language:o?.language,identifier:getIdentifier(i),description:o?.description?.value,publisher:o?.publisher?.value,published:o?.date,modified:o?.dctermsModified,subject:o?.subject?.filter((({value:e,code:t})=>e||t))?.map((({value:e,code:t,scheme:r})=>({name:e,code:t,scheme:r}))),rights:o?.rights?.value};const d={art:"artist",aut:"author",bkp:"producer",clr:"colorist",edt:"editor",ill:"illustrator",trl:"translator",pbl:"publisher"},h=e=>t=>{const r=[...new Set(t.role?.map((({value:t,scheme:r})=>(r&&"marc:relators"!==r?null:d[t])??e)))],i={name:t.value,sortAs:t.fileAs};return[r?.length?r:[e],i]};return o?.creator?.map(h("author"))?.concat(o?.contributor?.map?.(h("contributor")))?.forEach((([e,t])=>e.forEach((e=>{this.metadata[e]?this.metadata[e].push(t):this.metadata[e]=[t]})))),this}async loadDocument(e){const t=await this.loadText(e.href);return this.parser.parseFromString(t,e.mediaType)}async loadMediaOverlay(e){const t=e.mediaOverlay;if(!t)return null;const r=this.resources.getItemByID(t),i=await this.#l(r.href);return parseSMIL(i,(e=>resolveURL(e,r.href)))}resolveCFI(e){return this.resources.resolveCFI(e)}resolveHref(e){const[t,r]=e.split("#"),i=this.resources.getItemByHref(decodeURI(t));return i?{index:this.resources.spine.findIndex((({idref:e})=>e===i.id)),anchor:r?e=>getHTMLFragment(e,r):()=>0}:null}splitTOCHref(e){return e?.split("#")??[]}getTOCFragment(e,t){return e.getElementById(t)??e.querySelector(`[name="${CSS.escape(t)}"]`)}isExternal(e){return isExternal(e)}async getCover(){const e=this.resources?.cover;return e?.href?new Blob([await this.loadBlob(e.href)],{type:e.mediaType}):null}async getCalibreBookmarks(){const e=await this.loadText("META-INF/calibre_bookmarks.txt");if(e?.startsWith("encoding=json+base64:")){const t=atob(e.slice(21));return JSON.parse(t)}}destroy(){this.#n?.destroy()}}