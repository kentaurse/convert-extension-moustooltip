import"./view.js";import{createTOCView}from"./ui/tree.js";import{createMenu}from"./ui/menu.js";import{Overlayer}from"../foliate-js/overlayer.js";const isZip=async e=>{const t=new Uint8Array(await e.slice(0,4).arrayBuffer());return 80===t[0]&&75===t[1]&&3===t[2]&&4===t[3]},makeZipLoader=async e=>{const{configure:t,ZipReader:i,BlobReader:n,TextWriter:a,BlobWriter:o}=await import("./vendor/zip.js");t({useWebWorkers:!1});const r=new i(new n(e)),s=await r.getEntries(),l=new Map(s.map((e=>[e.filename,e]))),c=e=>(t,...i)=>l.has(t)?e(l.get(t),...i):null;return{entries:s,loadText:c((e=>e.getData(new a))),loadBlob:c(((e,t)=>e.getData(new o(t)))),getSize:e=>l.get(e)?.uncompressedSize??0}},getFileEntries=async e=>e.isFile?e:(await Promise.all(Array.from(await new Promise(((t,i)=>e.createReader().readEntries((e=>t(e)),(e=>i(e))))),getFileEntries))).flat(),makeDirectoryLoader=async e=>{const t=await getFileEntries(e),i=await Promise.all(t.map((e=>new Promise(((t,i)=>e.file((i=>t([i,e.fullPath])),(e=>i(e)))))))),n=new Map(i.map((([t,i])=>[i.replace(e.fullPath+"/",""),t]))),a=new TextDecoder;return{loadText:async e=>{return t=await(e=>n.get(e)?.arrayBuffer()??null)(e),t?a.decode(t):null;var t},loadBlob:e=>n.get(e),getSize:e=>n.get(e)?.size??0}},isCBZ=({name:e,type:t})=>"application/vnd.comicbook+zip"===t||e.endsWith(".cbz"),isFB2=({name:e,type:t})=>"application/x-fictionbook+xml"===t||e.endsWith(".fb2"),isFBZ=({name:e,type:t})=>"application/x-zip-compressed-fb2"===t||e.endsWith(".fb2.zip")||e.endsWith(".fbz"),getView=async e=>{let t;if(e.isDirectory){const i=await makeDirectoryLoader(e),{EPUB:n}=await import("./epub.js");t=await new n(i).init()}else{if(!e.size)throw new Error("File not found");if(await isZip(e)){const i=await makeZipLoader(e);if(isCBZ(e)){const{makeComicBook:n}=await import("./comic-book.js");t=n(i,e)}else if(isFBZ(e)){const{makeFB2:e}=await import("./fb2.js"),{entries:n}=i,a=n.find((e=>e.filename.endsWith(".fb2"))),o=await i.loadBlob((a??n[0]).filename);t=await e(o)}else{const{EPUB:e}=await import("./epub.js");t=await new e(i).init()}}else{const{isMOBI:i,MOBI:n}=await import("./mobi.js");if(await i(e)){const i=await import("./vendor/fflate.js");t=await new n({unzlib:i.unzlibSync}).open(e)}else if(isFB2(e)){const{makeFB2:i}=await import("./fb2.js");t=await i(e)}}}if(!t)throw new Error("File type not supported");const i=document.createElement("foliate-view");return document.body.append(i),await i.open(t),i},getCSS=({spacing:e,justify:t,hyphenate:i})=>`\n    @namespace epub "http://www.idpf.org/2007/ops";\n    html {\n        color-scheme: light dark;\n    }\n    /* https://github.com/whatwg/html/issues/5426 */\n    @media (prefers-color-scheme: dark) {\n        a:link {\n            color: lightblue;\n        }\n    }\n    p, li, blockquote, dd {\n        line-height: ${e};\n        text-align: ${t?"justify":"start"};\n        -webkit-hyphens: ${i?"auto":"manual"};\n        hyphens: ${i?"auto":"manual"};\n        -webkit-hyphenate-limit-before: 3;\n        -webkit-hyphenate-limit-after: 2;\n        -webkit-hyphenate-limit-lines: 2;\n        hanging-punctuation: allow-end last;\n        widows: 2;\n    }\n    /* prevent the above from overriding the align attribute */\n    [align="left"] { text-align: left; }\n    [align="right"] { text-align: right; }\n    [align="center"] { text-align: center; }\n    [align="justify"] { text-align: justify; }\n\n    pre {\n        white-space: pre-wrap !important;\n    }\n    aside[epub|type~="endnote"],\n    aside[epub|type~="footnote"],\n    aside[epub|type~="note"],\n    aside[epub|type~="rearnote"] {\n        display: none;\n    }\n`,$=document.querySelector.bind(document),locales="en",percentFormat=new Intl.NumberFormat("en",{style:"percent"});class Reader{#e;style={spacing:1.4,justify:!0,hyphenate:!0};annotations=new Map;annotationsByValue=new Map;closeSideBar(){$("#dimming-overlay").classList.remove("show"),$("#side-bar").classList.remove("show")}constructor(){$("#side-bar-button").addEventListener("click",(()=>{$("#dimming-overlay").classList.add("show"),$("#side-bar").classList.add("show")})),$("#dimming-overlay").addEventListener("click",(()=>this.closeSideBar()));const e=createMenu([{name:"layout",label:"Layout",type:"radio",items:[["Paginated","paginated"],["Scrolled","scrolled"]],onclick:e=>{this.view?.renderer.setAttribute("flow",e)}}]);e.element.classList.add("menu"),$("#menu-button").append(e.element),$("#menu-button > button").addEventListener("click",(()=>e.element.classList.toggle("show"))),e.groups.layout.select("paginated")}async open(e){this.view=await getView(e),this.view.addEventListener("load",this.#t.bind(this)),this.view.addEventListener("relocate",this.#i.bind(this));const{book:t}=this.view;this.view.renderer.setStyles?.(getCSS(this.style)),this.view.renderer.next(),$("#header-bar").style.visibility="visible",$("#nav-bar").style.visibility="visible",$("#left-button").addEventListener("click",(()=>this.view.goLeft())),$("#right-button").addEventListener("click",(()=>this.view.goRight()));const i=$("#progress-slider");i.dir=t.dir,i.addEventListener("input",(e=>this.view.goToFraction(parseFloat(e.target.value))));const n=t.sections.filter((e=>"no"!==e.linear)).map((e=>e.size));if(n.length<100){const e=n.reduce(((e,t)=>e+t),0);let t=0;for(const i of n.slice(0,-1)){t+=i;const n=document.createElement("option");n.value=t/e,$("#tick-marks").append(n)}}document.addEventListener("keydown",this.#n.bind(this));const a=t.metadata?.title??"Untitled Book";document.title=a,$("#side-bar-title").innerText=a;const o=t.metadata?.author;$("#side-bar-author").innerText="string"==typeof o?o:o?.map((e=>"string"==typeof e?e:e.name))?.join(", ")??"",Promise.resolve(t.getCover?.())?.then((e=>e?$("#side-bar-cover").src=URL.createObjectURL(e):null));const r=t.toc;r&&(this.#e=createTOCView(r,(e=>{this.view.goTo(e).catch((e=>console.error(e))),this.closeSideBar()})),$("#toc-view").append(this.#e.element));const s=await(t.getCalibreBookmarks?.());if(s){const{fromCalibreHighlight:e}=await import("./epubcfi.js");for(const t of s)if("highlight"===t.type){const i=e(t),n={value:i,color:t.style.which,note:t.notes},a=this.annotations.get(t.spine_index);a?a.push(n):this.annotations.set(t.spine_index,[n]),this.annotationsByValue.set(i,n)}this.view.addEventListener("create-overlay",(e=>{const{index:t}=e.detail,i=this.annotations.get(t);if(i)for(const e of i)this.view.addAnnotation(e)})),this.view.addEventListener("draw-annotation",(e=>{const{draw:t,annotation:i}=e.detail,{color:n}=i;t(Overlayer.highlight,{color:n})})),this.view.addEventListener("show-annotation",(e=>{const t=this.annotationsByValue.get(e.detail.value);t.note&&alert(t.note)}))}}#n(e){const t=e.key;"ArrowLeft"===t||"h"===t?this.view.goLeft():"ArrowRight"!==t&&"l"!==t||this.view.goRight()}#t({detail:{doc:e}}){e.addEventListener("keydown",this.#n.bind(this))}#i({detail:e}){const{fraction:t,location:i,tocItem:n,pageItem:a}=e,o=percentFormat.format(t),r=a?`Page ${a.label}`:`Loc ${i.current}`,s=$("#progress-slider");s.style.visibility="visible",s.value=t,s.title=`${o} Â· ${r}`,n?.href&&this.#e?.setCurrentHref?.(n.href)}}const open=async e=>{document.body.removeChild($("#drop-target"));const t=new Reader;globalThis.reader=t,await t.open(e)},dragOverHandler=e=>e.preventDefault(),dropHandler=e=>{e.preventDefault();const t=Array.from(e.dataTransfer.items).find((e=>"file"===e.kind));if(t){const e=t.webkitGetAsEntry();open(e.isFile?t.getAsFile():e).catch((e=>console.error(e)))}},dropTarget=$("#drop-target");dropTarget.addEventListener("drop",dropHandler),dropTarget.addEventListener("dragover",dragOverHandler),$("#file-input").addEventListener("change",(e=>open(e.target.files[0]).catch((e=>console.error(e))))),$("#file-button").addEventListener("click",(()=>$("#file-input").click()));const params=new URLSearchParams(location.search),url=params.get("url");url?fetch(url).then((e=>e.blob())).then((e=>open(new File([e],new URL(url).pathname)))).catch((e=>console.error(e))):dropTarget.style.visibility="visible";