const wait=t=>new Promise((e=>setTimeout(e,t))),debounce=(t,e,i)=>{let n;return(...s)=>{const r=i&&!n;n&&clearTimeout(n),n=setTimeout((()=>{n=null,i||t(...s)}),e),r&&t(...s)}},lerp=(t,e,i)=>i*(e-t)+t,easeOutQuad=t=>1-(1-t)*(1-t),animate=(t,e,i,n,s)=>new Promise((r=>{let o;const a=h=>{o??=h;const l=Math.min(1,(h-o)/i);var c,d;s((c=t,d=e,n(l)*(d-c)+c)),l<1?requestAnimationFrame(a):r()};requestAnimationFrame(a)})),uncollapse=t=>{if(!t?.collapsed)return t;const{endOffset:e,endContainer:i}=t;if(1===i.nodeType)return i;if(e+1<i.length)t.setEnd(i,e+1);else{if(!(e>1))return i.parentNode;t.setStart(i,e-1)}return t},makeRange=(t,e,i,n=i)=>{const s=t.createRange();return s.setStart(e,i),s.setEnd(e,n),s},bisectNode=(t,e,i,n=0,s=e.nodeValue.length)=>{if(s-n==1)return i(makeRange(t,e,n),makeRange(t,e,s))<0?n:s;const r=Math.floor(n+(s-n)/2),o=i(makeRange(t,e,n,r),makeRange(t,e,r,s));return o<0?bisectNode(t,e,i,n,r):o>0?bisectNode(t,e,i,r,s):r},{SHOW_ELEMENT,SHOW_TEXT,SHOW_CDATA_SECTION,FILTER_ACCEPT,FILTER_REJECT,FILTER_SKIP}=NodeFilter,filter=SHOW_ELEMENT|SHOW_TEXT|SHOW_CDATA_SECTION,getVisibleRange=(t,e,i,n)=>{const s=t.createTreeWalker(t.body,filter,{acceptNode:s=>{const r=s.localName?.toLowerCase();if("script"===r||"style"===r)return FILTER_REJECT;if(1===s.nodeType){const{left:t,right:r}=n(s.getBoundingClientRect());if(r<e||t>i)return FILTER_REJECT;if(t>=e&&r<=i)return FILTER_ACCEPT}else{if(!s.nodeValue?.trim())return FILTER_SKIP;const r=t.createRange();r.selectNodeContents(s);const{left:o,right:a}=n(r.getBoundingClientRect());if(a>=e&&o<=i)return FILTER_ACCEPT}return FILTER_SKIP}}),r=[];for(let t=s.nextNode();t;t=s.nextNode())r.push(t);const o=r[0]??t.body,a=r[r.length-1]??o,h=1===o.nodeType?0:bisectNode(t,o,((t,i)=>{const s=n(t.getBoundingClientRect()),r=n(i.getBoundingClientRect());return s.right<e&&r.left>e?0:r.left>e?-1:1})),l=1===a.nodeType?0:bisectNode(t,a,((t,e)=>{const s=n(t.getBoundingClientRect()),r=n(e.getBoundingClientRect());return s.right<i&&r.left>i?0:r.left>i?-1:1})),c=t.createRange();return c.setStart(o,h),c.setEnd(a,l),c},getDirection=t=>{const{defaultView:e}=t,{writingMode:i,direction:n}=e.getComputedStyle(t.body);return{vertical:"vertical-rl"===i||"vertical-lr"===i,rtl:"rtl"===t.body.dir||"rtl"===n||"rtl"===t.documentElement.dir}},getBackground=t=>{const e=t.defaultView.getComputedStyle(t.body);return"rgba(0, 0, 0, 0)"===e.backgroundColor&&"none"===e.backgroundImage?t.defaultView.getComputedStyle(t.documentElement).background:e.background},makeMarginals=(t,e)=>Array.from({length:t},(()=>{const t=document.createElement("div"),i=document.createElement("div");return t.append(i),i.setAttribute("part",e),t}));class View{#t=new ResizeObserver((()=>this.expand()));#e=document.createElement("div");#i=document.createElement("iframe");#n=document.createRange();#s;#r=!1;#o=!1;#a=!0;#h;#l={};constructor({container:t,onExpand:e}){this.container=t,this.onExpand=e,this.#i.setAttribute("part","filter"),this.#e.append(this.#i),Object.assign(this.#e.style,{boxSizing:"content-box",position:"relative",overflow:"hidden",flex:"0 0 auto",width:"100%",height:"100%",display:"flex",justifyContent:"center",alignItems:"center"}),Object.assign(this.#i.style,{overflow:"hidden",border:"0",display:"none",width:"100%",height:"100%"}),this.#i.setAttribute("sandbox","allow-same-origin allow-scripts"),this.#i.setAttribute("scrolling","no")}get element(){return this.#e}get document(){return this.#i.contentDocument}async load(t,e,i){if("string"!=typeof t)throw new Error(`${t} is not string`);return new Promise((n=>{this.#i.addEventListener("load",(()=>{const t=this.document;e?.(t),this.#i.style.display="block";const{vertical:s,rtl:r}=getDirection(t),o=getBackground(t);this.#i.style.display="none",this.#r=s,this.#o=r,this.#n.selectNodeContents(t.body);const a=i?.({vertical:s,rtl:r,background:o});this.#i.style.display="block",this.render(a),this.#t.observe(t.body),t.fonts.ready.then((()=>this.expand())),n()}),{once:!0}),this.#i.src=t}))}render(t){t&&(this.#a="scrolled"!==t.flow,this.#l=t,this.#a?this.columnize(t):this.scrolled(t))}scrolled({gap:t,columnWidth:e}){const i=this.#r,n=this.document;Object.assign(n.documentElement.style,{boxSizing:"border-box",padding:i?`${t}px 0`:`0 ${t}px`,columnWidth:"auto",height:"auto",width:"auto"}),Object.assign(n.body.style,{[i?"maxHeight":"maxWidth"]:`${e}px`,margin:"auto"}),this.setImageSize(),this.expand()}columnize({width:t,height:e,gap:i,columnWidth:n}){const s=this.#r;this.#h=s?e:t;const r=this.document;Object.assign(r.documentElement.style,{boxSizing:"border-box",columnWidth:`${Math.trunc(n)}px`,columnGap:`${i}px`,columnFill:"auto",...s?{width:`${t}px`}:{height:`${e}px`},padding:s?i/2+"px 0":`0 ${i/2}px`,overflow:"hidden",overflowWrap:"anywhere",position:"static",border:"0",margin:"0",maxHeight:"none",maxWidth:"none",minHeight:"none",minWidth:"none",webkitLineBoxContain:"block glyphs replaced"}),Object.assign(r.body.style,{maxHeight:"none",maxWidth:"none",margin:"0"}),this.setImageSize(),this.expand()}setImageSize(){const{width:t,height:e,margin:i}=this.#l,n=this.#r,s=this.document;for(const r of s.body.querySelectorAll("img, svg, video")){const{maxHeight:o,maxWidth:a}=s.defaultView.getComputedStyle(r);Object.assign(r.style,{maxHeight:n?"none"!==o&&"0px"!==o?o:"100%":e-2*i+"px",maxWidth:n?t-2*i+"px":"none"!==a&&"0px"!==a?a:"100%",objectFit:"contain",pageBreakInside:"avoid",breakInside:"avoid",boxSizing:"border-box"})}}expand(){if(this.#a){const t=this.#r?"height":"width",e=this.#r?"width":"height",i=this.#n.getBoundingClientRect()[t],n=Math.ceil(i/this.#h)*this.#h;this.#e.style.padding="0",this.#i.style[t]=`${n}px`,this.#e.style[t]=`${n+2*this.#h}px`,this.#i.style[e]="100%",this.#e.style[e]="100%",this.document&&(this.document.documentElement.style[t]=`${this.#h}px`),this.#s&&(this.#s.element.style.margin="0",this.#s.element.style.left=this.#r?"0":`${this.#h}px`,this.#s.element.style.top=this.#r?`${this.#h}px`:"0",this.#s.element.style[t]=`${n}px`,this.#s.redraw())}else{const t=this.#r?"width":"height",e=this.#r?"height":"width",i=this.document,n=i?.documentElement?.getBoundingClientRect()?.[t],s=n,{margin:r}=this.#l,o=this.#r?`0 ${r}px`:`${r}px 0`;this.#e.style.padding=o,this.#i.style[t]=`${s}px`,this.#e.style[t]=`${s}px`,this.#i.style[e]="100%",this.#e.style[e]="100%",this.#s&&(this.#s.element.style.margin=o,this.#s.element.style.left="0",this.#s.element.style.top="0",this.#s.element.style[t]=`${s}px`,this.#s.redraw())}this.onExpand()}set overlayer(t){this.#s=t,this.#e.append(t.element)}get overlayer(){return this.#s}destroy(){this.document&&this.#t.unobserve(this.document.body)}}export class Paginator extends HTMLElement{static observedAttributes=["flow","gap","margin","max-inline-size","max-block-size","max-column-count"];#c=this.attachShadow({mode:"open"});#t=new ResizeObserver((()=>this.render()));#d;#u;#g;#m;#p;#r=!1;#o=!1;#v=0;#f=-1;#y=0;#x=!1;#w=!1;#b;#T=new WeakMap;#E;#S;#R;pageAnimation=!0;constructor(){super(),this.#c.innerHTML='<style>\n        :host {\n            --_gap: 7%;\n            --_margin: 48px;\n            --_max-inline-size: 720px;\n            --_max-block-size: 1440px;\n            --_max-column-count: 2;\n            --_vertical: 0;\n            --_half-gap: calc(var(--_gap) / 2);\n            --_max-width: calc(\n                var(--_vertical) * var(--_max-block-size)\n                + (1 - var(--_vertical)) * var(--_max-inline-size) * var(--_max-column-count)\n            );\n            --_max-height: calc(\n                var(--_vertical) * var(--_max-inline-size) * var(--_max-column-count)\n                + (1 - var(--_vertical)) * var(--_max-block-size)\n            );\n            display: grid;\n            grid-template-columns:\n                minmax(var(--_half-gap), 1fr)\n                minmax(0, var(--_max-width))\n                minmax(var(--_half-gap), 1fr);\n            grid-template-rows:\n                minmax(var(--_margin), 1fr)\n                minmax(0, var(--_max-height))\n                minmax(var(--_margin), 1fr);\n            box-sizing: border-box;\n            position: relative;\n            overflow: hidden;\n            width: 100%;\n            height: 100%;\n        }\n        #background {\n            grid-column-start: 1;\n            grid-column-end: 4;\n            grid-row-start: 1;\n            grid-row-end: 4;\n        }\n        #container {\n            grid-column-start: 2;\n            grid-row-start: 2;\n            overflow: hidden;\n        }\n        :host([flow="scrolled"]) #container {\n            grid-column-start: 1;\n            grid-column-end: 4;\n            grid-row-start: 1;\n            grid-row-end: 4;\n            overflow: auto;\n        }\n        #header {\n            grid-column-start: 2;\n            grid-row-start: 1;\n        }\n        #footer {\n            grid-column-start: 2;\n            grid-row-start: 3;\n            align-self: end;\n        }\n        #header, #footer {\n            display: grid;\n            height: var(--_margin);\n        }\n        :is(#header, #footer) > * {\n            display: flex;\n            align-items: center;\n            min-width: 0;\n        }\n        :is(#header, #footer) > * > * {\n            width: 100%;\n            overflow: hidden;\n            white-space: nowrap;\n            text-overflow: ellipsis;\n            text-align: center;\n            font-size: .75em;\n            opacity: .6;\n        }\n        </style>\n        <div id="background" part="filter"></div>\n        <div id="header"></div>\n        <div id="container"></div>\n        <div id="footer"></div>\n        ',this.#d=this.#c.getElementById("background"),this.#u=this.#c.getElementById("container"),this.#g=this.#c.getElementById("header"),this.#m=this.#c.getElementById("footer"),this.#t.observe(this.#u),this.#u.addEventListener("scroll",debounce((()=>{this.scrolled&&(this.#x?this.#x=!1:this.#_("scroll"))}),250));const t={passive:!1};this.addEventListener("touchstart",this.#C.bind(this),t),this.addEventListener("touchmove",this.#z.bind(this),t),this.addEventListener("touchend",this.#k.bind(this)),this.addEventListener("load",(({detail:{doc:e}})=>{e.addEventListener("touchstart",this.#C.bind(this),t),e.addEventListener("touchmove",this.#z.bind(this),t),e.addEventListener("touchend",this.#k.bind(this))}))}attributeChangedCallback(t,e,i){switch(t){case"flow":this.render();break;case"gap":case"margin":case"max-block-size":case"max-column-count":this.style.setProperty("--_"+t,i);break;case"max-inline-size":this.style.setProperty("--_"+t,i),this.render()}}open(t){this.bookDir=t.dir,this.sections=t.sections}#M(){return this.#p&&this.#u.removeChild(this.#p.element),this.#p=new View({container:this,onExpand:this.#A.bind(this)}),this.#u.append(this.#p.element),this.#p}#I({vertical:t,rtl:e,background:i}){this.#r=t,this.#o=e,this.style.setProperty("--_vertical",t?1:0),this.#d.style.background=i;const{width:n,height:s}=this.#u.getBoundingClientRect(),r=t?s:n,o=getComputedStyle(this),a=parseFloat(o.getPropertyValue("--_max-inline-size")),h=parseInt(o.getPropertyValue("--_max-column-count")),l=parseFloat(o.getPropertyValue("--_margin"));this.#v=l;const c=parseFloat(o.getPropertyValue("--_gap"))/100,d=-c/(c-1)*r,u=this.getAttribute("flow");if("scrolled"===u){this.setAttribute("dir",t?"rtl":"ltr"),this.style.padding="0";const e=a;return this.heads=null,this.feet=null,this.#g.replaceChildren(),this.#m.replaceChildren(),{flow:u,margin:l,gap:d,columnWidth:e}}const g=Math.min(h,Math.ceil(r/a)),m=r/g-d;this.setAttribute("dir",e?"rtl":"ltr");const p=t?Math.min(2,Math.ceil(n/a)):g,v={gridTemplateColumns:`repeat(${p}, 1fr)`,gap:`${d}px`,padding:t?"0":`0 ${d/2}px`,direction:"rtl"===this.bookDir?"rtl":"ltr"};Object.assign(this.#g.style,v),Object.assign(this.#m.style,v);const f=makeMarginals(p,"head"),y=makeMarginals(p,"foot");return this.heads=f.map((t=>t.children[0])),this.feet=y.map((t=>t.children[0])),this.#g.replaceChildren(...f),this.#m.replaceChildren(...y),{height:s,width:n,margin:l,gap:d,columnWidth:m}}render(){this.#p&&(this.#p.render(this.#I({vertical:this.#r,rtl:this.#o})),this.#A())}get scrolled(){return"scrolled"===this.getAttribute("flow")}get scrollProp(){const{scrolled:t}=this;return this.#r?t?"scrollLeft":"scrollTop":t?"scrollTop":"scrollLeft"}get sideProp(){const{scrolled:t}=this;return this.#r?t?"width":"height":t?"height":"width"}get size(){return this.#u.getBoundingClientRect()[this.sideProp]}get viewSize(){return this.#p.element.getBoundingClientRect()[this.sideProp]}get start(){return Math.abs(this.#u[this.scrollProp])}get end(){return this.start+this.size}get page(){return Math.floor((this.start+this.end)/2/this.size)}get pages(){return Math.round(this.viewSize/this.size)}scrollBy(t,e){const i=this.#r?e:t,n=this.#u,{scrollProp:s}=this,[r,o,a]=this.#E,h=this.#o,l=h?r-a:r-o,c=h?r+o:r+a;n[s]=Math.max(l,Math.min(c,n[s]+i))}snap(t,e){const i=this.#r?e:t,[n,s,r]=this.#E,{start:o,end:a,pages:h,size:l}=this,c=Math.abs(n)-s,d=Math.abs(n)+r,u=i*(this.#o?-l:l),g=Math.floor(Math.max(c,Math.min(d,(o+a)/2+(isNaN(u)?0:u)))/l);this.#P(g,"snap").then((()=>{const t=g<=0?-1:g>=h-1?1:null;if(t)return this.#L({index:this.#B(t),anchor:t<0?()=>1:()=>0})}))}#C(t){const e=t.changedTouches[0];this.#S={x:e?.screenX,y:e?.screenY,t:t.timeStamp,vx:0,xy:0}}#z(t){const e=this.#S;if(e.pinched)return;if(e.pinched=globalThis.visualViewport.scale>1,this.scrolled||e.pinched)return;if(t.touches.length>1)return void(this.#R&&t.preventDefault());t.preventDefault();const i=t.changedTouches[0],n=i.screenX,s=i.screenY,r=e.x-n,o=e.y-s,a=t.timeStamp-e.t;e.x=n,e.y=s,e.t=t.timeStamp,e.vx=r/a,e.vy=o/a,this.#R=!0,this.scrollBy(r,o)}#k(){this.#R=!1,this.scrolled||requestAnimationFrame((()=>{1===globalThis.visualViewport.scale&&this.snap(this.#S.vx,this.#S.vy)}))}#O(){if(this.scrolled){const t=this.viewSize,e=this.#v;return this.#r?({left:i,right:n})=>({left:t-n-e,right:t-i-e}):({top:t,bottom:i})=>({left:t+e,right:i+e})}const t=this.pages*this.size;return this.#o?({left:e,right:i})=>({left:t-i,right:t-e}):this.#r?({top:t,bottom:e})=>({left:t,right:e}):t=>t}async#F(t,e){if(this.scrolled){const i=this.#O()(t).left-this.#v;return this.#W(i,e)}const i=this.#O()(t).left+this.#v/2;return this.#P(Math.floor(i/this.size)+(this.#o?-1:1),e)}async#W(t,e,i){const n=this.#u,{scrollProp:s,size:r}=this;return n[s]===t?(this.#E=[t,this.atStart?0:r,this.atEnd?0:r],void this.#_(e)):(this.scrolled&&this.#r&&(t=-t),"snap"===e||i&&this.pageAnimation?(o=n[s],a=t,300,h=easeOutQuad,l=t=>n[s]=t,new Promise((t=>{let e;const i=n=>{e??=n;const s=Math.min(1,(n-e)/300);var r,c;l((r=o,c=a,h(s)*(c-r)+r)),s<1?requestAnimationFrame(i):t()};requestAnimationFrame(i)}))).then((()=>{this.#E=[t,this.atStart?0:r,this.atEnd?0:r],this.#_(e)})):(n[s]=t,this.#E=[t,this.atStart?0:r,this.atEnd?0:r],void this.#_(e)));var o,a,h,l}async#P(t,e,i){const n=this.size*(this.#o?-t:t);return this.#W(n,e,i)}async#A(t){const e=uncollapse(this.#y)?.getClientRects?.();if(e){const i=Array.from(e).find((t=>t.width>0&&t.height>0))||e[0];if(!i)return;return await this.#F(i,"anchor"),void(t&&this.#$())}if(this.scrolled)return void await this.#W(this.#y*this.viewSize,"anchor");const{pages:i}=this;if(!i)return;const n=i-2,s=Math.round(this.#y*(n-1));await this.#P(s+1,"anchor")}#$(){const{defaultView:t}=this.#p.document;if(this.#y instanceof t.Range){const e=t.getSelection();e.removeAllRanges(),e.addRange(this.#y)}}#N(){if(this.scrolled)return getVisibleRange(this.#p.document,this.start+this.#v,this.end-this.#v,this.#O());const t=this.#o?-this.size:this.size;return getVisibleRange(this.#p.document,this.start-t,this.end-t,this.#O())}#_(t){const e=this.#N();"anchor"!==t?this.#y=e:this.#x=!0;const i={reason:t,range:e,index:this.#f};if(this.scrolled)i.fraction=this.start/this.viewSize;else if(this.pages>0){const{page:t,pages:e}=this;this.#g.style.visibility=t>1?"visible":"hidden",i.fraction=(t-1)/(e-2),i.size=1/(e-2)}this.dispatchEvent(new CustomEvent("relocate",{detail:i}))}async#j(t){const{index:e,src:i,anchor:n,onLoad:s,select:r}=await t;if(this.#f=e,i){const t=this.#M(),n=t=>{if(t.head){const e=t.createElement("style");t.head.prepend(e);const i=t.createElement("style");t.head.append(i),this.#T.set(t,[e,i])}s?.({doc:t,index:e})},r=this.#I.bind(this);await t.load(i,n,r),this.dispatchEvent(new CustomEvent("create-overlayer",{detail:{doc:t.document,index:e,attach:e=>t.overlayer=e}})),this.#p=t}this.#y=("function"==typeof n?n(this.#p.document):n)??0,await this.#A(r)}#V(t){return t>=0&&t<=this.sections.length-1}async#L({index:t,anchor:e,select:i}){if(t===this.#f)await this.#j({index:t,anchor:e,select:i});else{const n=this.#f,s=t=>{this.sections[n]?.unload?.(),this.setStyles(this.#b),this.dispatchEvent(new CustomEvent("load",{detail:t}))};await this.#j(Promise.resolve(this.sections[t].load()).then((n=>({index:t,src:n,anchor:e,onLoad:s,select:i}))).catch((e=>(console.warn(e),console.warn(new Error(`Failed to load section ${t}`)),{}))))}}async goTo(t){if(this.#w)return;const e=await t;return this.#V(e.index)?this.#L(e):void 0}#H(t){if(!this.#p)return!0;if(this.scrolled)return!(this.start>0)||this.#W(Math.max(0,this.start-(t??this.size)),null,!0);if(this.atStart)return;const e=this.page-1;return this.#P(e,"page",!0).then((()=>e<=0))}#D(t){if(!this.#p)return!0;if(this.scrolled)return!(this.viewSize-this.end>2)||this.#W(Math.min(this.viewSize,t?this.start+t:this.end),null,!0);if(this.atEnd)return;const e=this.page+1,i=this.pages;return this.#P(e,"page",!0).then((()=>e>=i-1))}get atStart(){return null==this.#B(-1)&&this.page<=1}get atEnd(){return null==this.#B(1)&&this.page>=this.pages-2}#B(t){for(let e=this.#f+t;this.#V(e);e+=t)if("no"!==this.sections[e]?.linear)return e}async#q(t,e){if(this.#w)return;this.#w=!0;const i=-1===t,n=await(i?this.#H(e):this.#D(e));n&&await this.#L({index:this.#B(t),anchor:i?()=>1:()=>0}),!n&&this.pageAnimation||await(100,new Promise((t=>setTimeout(t,100)))),this.#w=!1}prev(t){return this.#q(-1,t)}next(t){return this.#q(1,t)}prevSection(){return this.goTo({index:this.#B(-1)})}nextSection(){return this.goTo({index:this.#B(1)})}firstSection(){const t=this.sections.findIndex((t=>"no"!==t.linear));return this.goTo({index:t})}lastSection(){const t=this.sections.findLastIndex((t=>"no"!==t.linear));return this.goTo({index:t})}getContents(){return this.#p?[{index:this.#f,overlayer:this.#p.overlayer,doc:this.#p.document}]:[]}setStyles(t){this.#b=t;const e=this.#T.get(this.#p?.document);if(!e)return;const[i,n]=e;if(Array.isArray(t)){const[e,s]=t;i.textContent=e,n.textContent=s}else n.textContent=t;this.#p?.document?.fonts?.ready?.then((()=>this.#p.expand()))}destroy(){this.#t.unobserve(this),this.#p.destroy(),this.#p=null,this.sections[this.#f]?.unload?.()}}customElements.define("foliate-paginator",Paginator);