import*as CFI from"./epubcfi.js";import{TOCProgress,SectionProgress}from"./progress.js";import{Overlayer}from"./overlayer.js";const SEARCH_PREFIX="foliate-search:";class History extends EventTarget{#e=[];#t=-1;pushState(e){const t=this.#e[this.#t];t===e||t?.fraction&&t.fraction===e.fraction||(this.#e[++this.#t]=e,this.#e.length=this.#t+1,this.dispatchEvent(new Event("index-change")))}replaceState(e){const t=this.#t;this.#e[t]=e}back(){const e=this.#t;if(e<=0)return;const t={state:this.#e[e-1]};this.#t=e-1,this.dispatchEvent(new CustomEvent("popstate",{detail:t})),this.dispatchEvent(new Event("index-change"))}forward(){const e=this.#t;if(e>=this.#e.length-1)return;const t={state:this.#e[e+1]};this.#t=e+1,this.dispatchEvent(new CustomEvent("popstate",{detail:t})),this.dispatchEvent(new Event("index-change"))}get canGoBack(){return this.#t>0}get canGoForward(){return this.#t<this.#e.length-1}clear(){this.#e=[],this.#t=-1}}const textWalker=function*(e,t){const s=NodeFilter.SHOW_ELEMENT|NodeFilter.SHOW_TEXT|NodeFilter.SHOW_CDATA_SECTION,{FILTER_ACCEPT:r,FILTER_REJECT:o,FILTER_SKIP:n}=NodeFilter,i=e.createTreeWalker(e.body,s,{acceptNode:e=>{const t=e.localName?.toLowerCase();return"script"===t||"style"===t?o:1===e.nodeType?n:r}}),a=[];for(let e=i.nextNode();e;e=i.nextNode())a.push(e);const c=a.map((e=>e.nodeValue)),h=(t,s,r,o)=>{const n=e.createRange();return n.setStart(a[t],s),n.setEnd(a[r],o),n};for(const e of t(c,h))yield e},languageInfo=e=>{if(!e)return{};try{const t=Intl.getCanonicalLocales(e)[0],s=new Intl.Locale(t),r=["zh","ja","kr"].includes(s.language),o=(s.getTextInfo?.()??s.textInfo)?.direction;return{canonical:t,locale:s,isCJK:r,direction:o}}catch(e){return console.warn(e),{}}};export class View extends HTMLElement{#s=this.attachShadow({mode:"open"});#r;#o;#n;#i=new Map;isFixedLayout=!1;lastLocation;history=new History;constructor(){super(),this.history.addEventListener("popstate",(({detail:e})=>{const t=this.resolveNavigation(e.state);this.renderer.goTo(t)}))}async open(e){if(this.book=e,this.language=languageInfo(e.metadata?.language),e.splitTOCHref&&e.getTOCFragment){const t=e.sections.map((e=>e.id));this.#r=new SectionProgress(e.sections,1500,1600);const s=e.splitTOCHref.bind(e),r=e.getTOCFragment.bind(e);this.#o=new TOCProgress({toc:e.toc??[],ids:t,splitHref:s,getFragment:r}),this.#n=new TOCProgress({toc:e.pageList??[],ids:t,splitHref:s,getFragment:r})}this.isFixedLayout="pre-paginated"===this.book.rendition?.layout,this.isFixedLayout?(await import("./fixed-layout.js"),this.renderer=document.createElement("foliate-fxl")):(await import("./paginator.js"),this.renderer=document.createElement("foliate-paginator")),this.renderer.setAttribute("exportparts","head,foot,filter"),this.renderer.addEventListener("load",(e=>this.#a(e.detail))),this.renderer.addEventListener("relocate",(e=>this.#c(e.detail))),this.renderer.addEventListener("create-overlayer",(e=>e.detail.attach(this.#h(e.detail)))),this.renderer.open(e),this.#s.append(this.renderer)}close(){this.renderer?.destroy(),this.renderer?.remove(),this.#r=null,this.#o=null,this.#n=null,this.#i=new Map,this.lastLocation=null,this.history.clear()}goToTextStart(){return this.goTo(this.book.landmarks?.find((e=>e.type.includes("bodymatter")||e.type.includes("text")))?.href??this.book.sections.findIndex((e=>"no"!==e.linear)))}async init({lastLocation:e,showTextStart:t}){const s=e?this.resolveNavigation(e):null;s?(await this.renderer.goTo(s),this.history.pushState(e)):t?await this.goToTextStart():(this.history.pushState(0),await this.next())}#l(e,t,s){return this.dispatchEvent(new CustomEvent(e,{detail:t,cancelable:s}))}#c({reason:e,range:t,index:s,fraction:r,size:o}){const n=this.#r?.getProgress(s,r,o)??{},i=this.#o?.getProgress(s,t),a=this.#n?.getProgress(s,t),c=this.getCFI(s,t);this.lastLocation={...n,tocItem:i,pageItem:a,cfi:c,range:t},"snap"!==e&&"page"!==e&&"scroll"!==e||this.history.replaceState(c),this.#l("relocate",this.lastLocation)}#a({doc:e,index:t}){e.documentElement.lang||=this.language.canonical??"",this.language.isCJK||(e.documentElement.dir||=this.language.direction??""),this.#d(e,t),this.#l("load",{doc:e,index:t})}#d(e,t){const{book:s}=this,r=s.sections[t];for(const t of e.querySelectorAll("a[href]"))t.addEventListener("click",(e=>{e.preventDefault();const o=t.getAttribute("href"),n=r?.resolveHref?.(o)??o;s?.isExternal?.(n)?Promise.resolve(this.#l("external-link",{a:t,href:n},!0)).then((e=>e?globalThis.open(n,"_blank"):null)).catch((e=>console.error(e))):Promise.resolve(this.#l("link",{a:t,href:n},!0)).then((e=>e?this.goTo(n):null)).catch((e=>console.error(e)))}))}async addAnnotation(e,t){const{value:s}=e;if(s.startsWith(SEARCH_PREFIX)){const e=s.replace(SEARCH_PREFIX,""),{index:r,anchor:o}=await this.resolveNavigation(e),n=this.#g(r);if(n){const{overlayer:e,doc:r}=n;if(t)return void e.remove(s);const i=r?o(r):o;e.add(s,i,Overlayer.outline)}return}const{index:r,anchor:o}=await this.resolveNavigation(s),n=this.#g(r);if(n){const{overlayer:r,doc:i}=n;if(r.remove(s),!t){const t=i?o(i):o,n=(e,o)=>r.add(s,t,e,o);this.#l("draw-annotation",{draw:n,annotation:e,doc:i,range:t})}}return{index:r,label:this.#o.getProgress(r)?.label??""}}deleteAnnotation(e){return this.addAnnotation(e,!0)}#g(e){return this.renderer.getContents().find((t=>t.index===e&&t.overlayer))}#h({doc:e,index:t}){const s=new Overlayer;e.addEventListener("click",(e=>{const[t,r]=s.hitTest(e);t&&!t.startsWith(SEARCH_PREFIX)&&this.#l("show-annotation",{value:t,range:r})}),!1);const r=this.#i.get(t);if(r)for(const e of r)this.addAnnotation(e);return this.#l("create-overlay",{index:t}),s}async showAnnotation(e){const{value:t}=e,s=await this.goTo(t);if(s){const{index:e,anchor:r}=s,{doc:o}=this.#g(e),n=r(o);this.#l("show-annotation",{value:t,range:n})}}getCFI(e,t){const s=this.book.sections[e].cfi??CFI.fake.fromIndex(e);return t?CFI.joinIndir(s,CFI.fromRange(t)):s}resolveCFI(e){if(this.book.resolveCFI)return this.book.resolveCFI(e);{const t=CFI.parse(e);return{index:CFI.fake.toIndex((t.parent??t).shift()),anchor:e=>CFI.toRange(e,t)}}}resolveNavigation(e){try{if("number"==typeof e)return{index:e};if("number"==typeof e.fraction){const[t,s]=this.#r.getSection(e.fraction);return{index:t,anchor:s}}return CFI.isCFI.test(e)?this.resolveCFI(e):this.book.resolveHref(e)}catch(t){console.error(t),console.error(`Could not resolve target ${e}`)}}async goTo(e){const t=this.resolveNavigation(e);try{return await this.renderer.goTo(t),this.history.pushState(e),t}catch(t){console.error(t),console.error(`Could not go to ${e}`)}}async goToFraction(e){const[t,s]=this.#r.getSection(e);await this.renderer.goTo({index:t,anchor:s}),this.history.pushState({fraction:e})}async select(e){try{const t=await this.resolveNavigation(e);await this.renderer.goTo({...t,select:!0}),this.history.pushState(e)}catch(t){console.error(t),console.error(`Could not go to ${e}`)}}deselect(){for(const{doc:e}of this.renderer.getContents())e.defaultView.getSelection().removeAllRanges()}async getTOCItemOf(e){try{const{index:t,anchor:s}=await this.resolveNavigation(e),r=await this.book.sections[t].createDocument(),o=s(r),n=o instanceof Range,i=n?o:r.createRange();return n||i.selectNodeContents(o),this.#o.getProgress(t,i)}catch(t){console.error(t),console.error(`Could not get ${e}`)}}async prev(e){await this.renderer.prev(e)}async next(e){await this.renderer.next(e)}goLeft(){return"rtl"===this.book.dir?this.next():this.prev()}goRight(){return"rtl"===this.book.dir?this.prev():this.next()}async*#u(e,t,s){const r=await this.book.sections[s].createDocument();for(const{range:o,excerpt:n}of e(r,t))yield{cfi:this.getCFI(s,o),excerpt:n}}async*#f(e,t){const{sections:s}=this.book;for(const[r,{createDocument:o}]of s.entries()){if(!o)continue;const n=await o(),i=Array.from(e(n,t),(({range:e,excerpt:t})=>({cfi:this.getCFI(r,e),excerpt:t}))),a=(r+1)/s.length;yield{progress:a},i.length&&(yield{index:r,subitems:i})}}async*search(e){this.clearSearch();const{searchMatcher:t}=await import("./search.js"),{query:s,index:r}=e,o=t(textWalker,{defaultLocale:this.language,...e}),n=null!=r?this.#u(o,s,r):this.#f(o,s),i=[];this.#i.set(r,i);for await(const e of n)if(e.subitems){const t=e.subitems.map((({cfi:e})=>({value:SEARCH_PREFIX+e})));this.#i.set(e.index,t);for(const e of t)this.addAnnotation(e);yield{label:this.#o.getProgress(e.index)?.label??"",subitems:e.subitems}}else{if(e.cfi){const t={value:SEARCH_PREFIX+e.cfi};i.push(t),this.addAnnotation(t)}yield e}yield"done"}clearSearch(){for(const e of this.#i.values())for(const t of e)this.deleteAnnotation(t);this.#i.clear()}}customElements.define("foliate-view",View);