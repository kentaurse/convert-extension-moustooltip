const unescapeHTML=e=>{if(!e)return"";const t=document.createElement("textarea");return t.innerHTML=e,t.value},MIME={XML:"application/xml",XHTML:"application/xhtml+xml",HTML:"text/html",CSS:"text/css",SVG:"image/svg+xml"},PDB_HEADER={name:[0,32,"string"],type:[60,4,"string"],creator:[64,4,"string"],numRecords:[76,2,"uint"]},PALMDOC_HEADER={compression:[0,2,"uint"],numTextRecords:[8,2,"uint"],recordSize:[10,2,"uint"],encryption:[12,2,"uint"]},MOBI_HEADER={magic:[16,4,"string"],length:[20,4,"uint"],type:[24,4,"uint"],encoding:[28,4,"uint"],uid:[32,4,"uint"],version:[36,4,"uint"],titleOffset:[84,4,"uint"],titleLength:[88,4,"uint"],localeRegion:[94,1,"uint"],localeLanguage:[95,1,"uint"],resourceStart:[108,4,"uint"],huffcdic:[112,4,"uint"],numHuffcdic:[116,4,"uint"],exthFlag:[128,4,"uint"],trailingFlags:[240,4,"uint"],indx:[244,4,"uint"]},KF8_HEADER={resourceStart:[108,4,"uint"],fdst:[192,4,"uint"],numFdst:[196,4,"uint"],frag:[248,4,"uint"],skel:[252,4,"uint"],guide:[260,4,"uint"]},EXTH_HEADER={magic:[0,4,"string"],length:[4,4,"uint"],count:[8,4,"uint"]},INDX_HEADER={magic:[0,4,"string"],length:[4,4,"uint"],type:[8,4,"uint"],idxt:[20,4,"uint"],numRecords:[24,4,"uint"],encoding:[28,4,"uint"],language:[32,4,"uint"],total:[36,4,"uint"],ordt:[40,4,"uint"],ligt:[44,4,"uint"],numLigt:[48,4,"uint"],numCncx:[52,4,"uint"]},TAGX_HEADER={magic:[0,4,"string"],length:[4,4,"uint"],numControlBytes:[8,4,"uint"]},HUFF_HEADER={magic:[0,4,"string"],offset1:[8,4,"uint"],offset2:[12,4,"uint"]},CDIC_HEADER={magic:[0,4,"string"],length:[4,4,"uint"],numEntries:[8,4,"uint"],codeLength:[12,4,"uint"]},FDST_HEADER={magic:[0,4,"string"],numEntries:[8,4,"uint"]},FONT_HEADER={flags:[8,4,"uint"],dataStart:[12,4,"uint"],keyLength:[16,4,"uint"],keyStart:[20,4,"uint"]},MOBI_ENCODING={1252:"windows-1252",65001:"utf-8"},EXTH_RECORD_TYPE={100:["creator","string",!0],101:["publisher"],103:["description"],104:["isbn"],105:["subject","string",!0],106:["date"],108:["contributor","string",!0],109:["rights"],110:["subjectCode","string",!0],112:["source","string",!0],113:["asin"],121:["boundary","uint"],122:["fixedLayout"],125:["numResources","uint"],126:["originalResolution"],127:["zeroGutter"],128:["zeroMargin"],129:["coverURI"],132:["regionMagnification"],201:["coverOffset","uint"],202:["thumbnailOffset","uint"],503:["title"],524:["language","string",!0],527:["pageProgressionDirection"]},MOBI_LANG={1:["ar","ar-SA","ar-IQ","ar-EG","ar-LY","ar-DZ","ar-MA","ar-TN","ar-OM","ar-YE","ar-SY","ar-JO","ar-LB","ar-KW","ar-AE","ar-BH","ar-QA"],2:["bg"],3:["ca"],4:["zh","zh-TW","zh-CN","zh-HK","zh-SG"],5:["cs"],6:["da"],7:["de","de-DE","de-CH","de-AT","de-LU","de-LI"],8:["el"],9:["en","en-US","en-GB","en-AU","en-CA","en-NZ","en-IE","en-ZA","en-JM",null,"en-BZ","en-TT","en-ZW","en-PH"],10:["es","es-ES","es-MX",null,"es-GT","es-CR","es-PA","es-DO","es-VE","es-CO","es-PE","es-AR","es-EC","es-CL","es-UY","es-PY","es-BO","es-SV","es-HN","es-NI","es-PR"],11:["fi"],12:["fr","fr-FR","fr-BE","fr-CA","fr-CH","fr-LU","fr-MC"],13:["he"],14:["hu"],15:["is"],16:["it","it-IT","it-CH"],17:["ja"],18:["ko"],19:["nl","nl-NL","nl-BE"],20:["no","nb","nn"],21:["pl"],22:["pt","pt-BR","pt-PT"],23:["rm"],24:["ro"],25:["ru"],26:["hr",null,"sr"],27:["sk"],28:["sq"],29:["sv","sv-SE","sv-FI"],30:["th"],31:["tr"],32:["ur"],33:["id"],34:["uk"],35:["be"],36:["sl"],37:["et"],38:["lv"],39:["lt"],41:["fa"],42:["vi"],43:["hy"],44:["az"],45:["eu"],46:["hsb"],47:["mk"],48:["st"],49:["ts"],50:["tn"],52:["xh"],53:["zu"],54:["af"],55:["ka"],56:["fo"],57:["hi"],58:["mt"],59:["se"],62:["ms"],63:["kk"],65:["sw"],67:["uz",null,"uz-UZ"],68:["tt"],69:["bn"],70:["pa"],71:["gu"],72:["or"],73:["ta"],74:["te"],75:["kn"],76:["ml"],77:["as"],78:["mr"],79:["sa"],82:["cy","cy-GB"],83:["gl","gl-ES"],87:["kok"],97:["ne"],98:["fy"]},concatTypedArray=(e,t)=>{const r=new e.constructor(e.length+t.length);return r.set(e),r.set(t,e.length),r},concatTypedArray3=(e,t,r)=>{const s=new e.constructor(e.length+t.length+r.length);return s.set(e),s.set(t,e.length),s.set(r,e.length+t.length),s},decoder=new TextDecoder,getString=e=>decoder.decode(e),getUint=e=>{if(!e)return;const t=e.byteLength,r=4===t?"getUint32":2===t?"getUint16":"getUint8";return new DataView(e)[r](0)},getStruct=(e,t)=>Object.fromEntries(Array.from(Object.entries(e)).map((([e,[r,s,n]])=>[e,("string"===n?getString:getUint)(t.slice(r,r+s))]))),getDecoder=e=>new TextDecoder(MOBI_ENCODING[e]),getVarLen=(e,t=0)=>{let r=0,s=0;for(const n of e.subarray(t,t+4))if(r=r<<7|(127&n)>>>0,s++,128&n)break;return{value:r,length:s}},getVarLenFromEnd=e=>{let t=0;for(const r of e.subarray(-4))128&r&&(t=0),t=t<<7|127&r;return t},countBitsSet=e=>{let t=0;for(;e>0;e>>=1)1==(1&e)&&t++;return t},countUnsetEnd=e=>{let t=0;for(;0==(1&e);)e>>=1,t++;return t},decompressPalmDOC=e=>{let t=[];for(let r=0;r<e.length;r++){const s=e[r];if(0===s)t.push(0);else if(s<=8)for(const n of e.subarray(r+1,(r+=s)+1))t.push(n);else if(s<=127)t.push(s);else if(s<=191){const n=s<<8|e[1+r++],i=(16383&n)>>>3,a=3+(7&n);for(let e=0;e<a;e++)t.push(t[t.length-i])}else t.push(32,128^s)}return Uint8Array.from(t)},read32Bits=(e,t)=>{const r=t+32,s=r>>3;let n=0n;for(let r=t>>3;r<=s;r++)n=n<<8n|BigInt(e[r]??0);return n>>8n-BigInt(7&r)&0xffffffffn},huffcdic=async(e,t)=>{const r=await t(e.huffcdic),{magic:s,offset1:n,offset2:i}=getStruct(HUFF_HEADER,r);if("HUFF"!==s)throw new Error("Invalid HUFF record");const a=Array.from({length:256},((e,t)=>n+4*t)).map((e=>getUint(r.slice(e,e+4)))).map((e=>[128&e,31&e,e>>>8])),o=[null].concat(Array.from({length:32},((e,t)=>i+8*t)).map((e=>[getUint(r.slice(e,e+4)),getUint(r.slice(e+4,e+8))]))),c=[];for(let r=1;r<e.numHuffcdic;r++){const s=await t(e.huffcdic+r),n=getStruct(CDIC_HEADER,s);if("CDIC"!==n.magic)throw new Error("Invalid CDIC record");const i=Math.min(1<<n.codeLength,n.numEntries-c.length),a=s.slice(n.length);for(let e=0;e<i;e++){const t=getUint(a.slice(2*e,2*e+2)),r=getUint(a.slice(t,t+2)),s=32767&r,n=32768&r,i=new Uint8Array(a.slice(t+2,t+2+s));c.push([i,n])}}const l=e=>{let t=new Uint8Array;const r=8*e.byteLength;for(let s=0;s<r;){const n=Number(read32Bits(e,s));let[i,h,u]=a[n>>>24];if(!i){for(;n>>>32-h<o[h][0];)h+=1;u=o[h][1]}if((s+=h)>r)break;const d=u-(n>>>32-h);let[g,f]=c[d];f||(g=l(g),c[d]=[g,!0]),t=concatTypedArray(t,g)}return t};return l},getIndexData=async(e,t)=>{const r=await t(e),s=getStruct(INDX_HEADER,r);if("INDX"!==s.magic)throw new Error("Invalid INDX record");const n=getDecoder(s.encoding),i=r.slice(s.length),a=getStruct(TAGX_HEADER,i);if("TAGX"!==a.magic)throw new Error("Invalid TAGX section");const o=(a.length-12)/4,c=Array.from({length:o},((e,t)=>new Uint8Array(i.slice(12+4*t,12+4*t+4)))),l={};let h=0;for(let r=0;r<s.numCncx;r++){const i=await t(e+s.numRecords+r+1),a=new Uint8Array(i);for(let e=0;e<a.byteLength;){const t=e,{value:r,length:s}=getVarLen(a,e);e+=s;const o=i.slice(e,e+r);e+=r,l[h+t]=n.decode(o)}h+=65536}const u=[];for(let r=0;r<s.numRecords;r++){const s=await t(e+1+r),n=new Uint8Array(s),i=getStruct(INDX_HEADER,s);if("INDX"!==i.magic)throw new Error("Invalid INDX record");for(let e=0;e<i.numRecords;e++){const t=i.idxt+4+2*e,r=getUint(s.slice(t,t+2)),o=getUint(s.slice(r,r+1)),l=getString(s.slice(r+1,r+1+o)),h=[],d=r+1+o;let g=0,f=d+a.numControlBytes;for(const[e,t,r,i]of c){if(1&i){g++;continue}const a=d+g,o=getUint(s.slice(a,a+1))&r;if(o===r)if(countBitsSet(r)>1){const{value:r,length:s}=getVarLen(n,f);h.push([e,null,r,t]),f+=s}else h.push([e,1,null,t]);else h.push([e,o>>countUnsetEnd(r),null,t])}const p={};for(const[e,t,r,s]of h){const i=[];if(null!=t)for(let e=0;e<t*s;e++){const{value:e,length:t}=getVarLen(n,f);i.push(e),f+=t}else{let e=0;for(;e<r;){const{value:t,length:r}=getVarLen(n,f);i.push(t),f+=r,e+=r}}p[e]=i}u.push({name:l,tagMap:p})}}return{table:u,cncx:l}},getNCX=async(e,t)=>{const{table:r,cncx:s}=await getIndexData(e,t),n=r.map((({tagMap:e},t)=>({index:t,offset:e[1]?.[0],size:e[2]?.[0],label:s[e[3]]??"",headingLevel:e[4]?.[0],pos:e[6],parent:e[21]?.[0],firstChild:e[22]?.[0],lastChild:e[23]?.[0]}))),i=e=>(null==e.firstChild||(e.children=n.filter((t=>t.parent===e.index)).map(i)),e);return n.filter((e=>0===e.headingLevel)).map(i)},getEXTH=(e,t)=>{const{magic:r,count:s}=getStruct(EXTH_HEADER,e);if("EXTH"!==r)throw new Error("Invalid EXTH header");const n=getDecoder(t),i={};let a=12;for(let t=0;t<s;t++){const t=getUint(e.slice(a,a+4)),r=getUint(e.slice(a+4,a+8));if(t in EXTH_RECORD_TYPE){const[s,o,c]=EXTH_RECORD_TYPE[t],l=e.slice(a+8,a+r),h="uint"===o?getUint(l):n.decode(l);c?(i[s]??=[],i[s].push(h)):i[s]=h}a+=r}return i},getFont=async(e,t)=>{const{flags:r,dataStart:s,keyLength:n,keyStart:i}=getStruct(FONT_HEADER,e),a=new Uint8Array(e.slice(s));if(2&r){const t=16===n?1024:1040,r=new Uint8Array(e.slice(i,i+n)),s=Math.min(t,a.length);for(var o=0;o<s;o++)a[o]=a[o]^r[o%r.length]}if(1&r)try{return await t(a)}catch(e){console.warn(e),console.warn("Failed to decompress font")}return a};export const isMOBI=async e=>"BOOKMOBI"===getString(await e.slice(60,68).arrayBuffer());class PDB{#e;#t;pdb;async open(e){this.#e=e;const t=getStruct(PDB_HEADER,await e.slice(0,78).arrayBuffer());this.pdb=t;const r=await e.slice(78,78+8*t.numRecords).arrayBuffer();this.#t=Array.from({length:t.numRecords},((e,t)=>getUint(r.slice(8*t,8*t+4)))).map(((e,t,r)=>[e,r[t+1]]))}loadRecord(e){const t=this.#t[e];if(!t)throw new RangeError("Record index out of bounds");return this.#e.slice(...t).arrayBuffer()}async loadMagic(e){const t=this.#t[e][0];return getString(await this.#e.slice(t,t+4).arrayBuffer())}}export class MOBI extends PDB{#r=0;#s;#n;#i;#a;#o;constructor({unzlib:e}){super(),this.unzlib=e}async open(e){await super.open(e),this.headers=this.#c(await super.loadRecord(0)),this.#s=this.headers.mobi.resourceStart;let t=this.headers.mobi.version>=8;if(!t){const e=this.headers.exth?.boundary;if(e<4294967295)try{this.headers=this.#c(await super.loadRecord(e)),this.#r=e,t=!0}catch(e){console.warn(e),console.warn("Failed to open KF8; falling back to MOBI")}}return await this.#l(),t?new KF8(this).init():new MOBI6(this).init()}#c(e){const t=getStruct(PALMDOC_HEADER,e),r=getStruct(MOBI_HEADER,e);if("MOBI"!==r.magic)throw new Error("Missing MOBI header");const{titleOffset:s,titleLength:n,localeLanguage:i,localeRegion:a}=r;r.title=e.slice(s,s+n);const o=MOBI_LANG[i];return r.language=o?.[a>>2]??o?.[0],{palmdoc:t,mobi:r,exth:64&r.exthFlag?getEXTH(e.slice(r.length+16),r.encoding):null,kf8:r.version>=8?getStruct(KF8_HEADER,e):null}}async#l(){const{palmdoc:e,mobi:t}=this.headers;this.#n=getDecoder(t.encoding),this.#i=new TextEncoder;const{compression:r}=e;if(this.#a=1===r?e=>e:2===r?decompressPalmDOC:17480===r?await huffcdic(t,this.loadRecord.bind(this)):null,!this.#a)throw new Error("Unknown compression type");const{trailingFlags:s}=t,n=1&s,i=countBitsSet(s>>>1);this.#o=e=>{for(let t=0;t<i;t++){const t=getVarLenFromEnd(e);e=e.subarray(0,-t)}if(n){const t=1+(3&e[e.length-1]);e=e.subarray(0,-t)}return e}}decode(...e){return this.#n.decode(...e)}encode(...e){return this.#i.encode(...e)}loadRecord(e){return super.loadRecord(this.#r+e)}loadMagic(e){return super.loadMagic(this.#r+e)}loadText(e){return this.loadRecord(e+1).then((e=>new Uint8Array(e))).then(this.#o).then(this.#a)}async loadResource(e){const t=await super.loadRecord(this.#s+e),r=getString(t.slice(0,4));return"FONT"===r?getFont(t,this.unzlib):"VIDE"===r||"AUDI"===r?t.slice(12):t}getNCX(){const e=this.headers.mobi.indx;if(e<4294967295)return getNCX(e,this.loadRecord.bind(this))}getMetadata(){const{mobi:e,exth:t}=this.headers;return{identifier:e.uid.toString(),title:unescapeHTML(t?.title||this.decode(e.title)),author:t?.creator?.map(unescapeHTML),publisher:unescapeHTML(t?.publisher),language:t?.language??e.language,published:t?.date,description:unescapeHTML(t?.description),subject:t?.subject?.map(unescapeHTML),rights:unescapeHTML(t?.rights)}}async getCover(){const{exth:e}=this.headers,t=e?.coverOffset<4294967295?e?.coverOffset:e?.thumbnailOffset<4294967295?e?.thumbnailOffset:null;if(null!=t){const e=await this.loadResource(t);return new Blob([e])}}}const mbpPagebreakRegex=/<\s*(?:mbp:)?pagebreak[^>]*>/gi,fileposRegex=/<[^<>]+filepos=['"]{0,1}(\d+)[^<>]*>/gi;class MOBI6{parser=new DOMParser;serializer=new XMLSerializer;#h=new Map;#u=new Map;#d=new Map;#g;#f=[];#p=MIME.HTML;constructor(e){this.mobi=e}async init(){let e=new Uint8Array;for(let t=0;t<this.mobi.headers.palmdoc.numTextRecords;t++)e=concatTypedArray(e,await this.mobi.loadText(t));const t=Array.from(new Uint8Array(e),(e=>String.fromCharCode(e))).join("");this.#g=[0].concat(Array.from(t.matchAll(mbpPagebreakRegex),(e=>e.index))).map(((e,r,s)=>t.slice(e,s[r+1]))).map((e=>Uint8Array.from(e,(e=>e.charCodeAt(0))))).map((e=>({book:this,raw:e}))).reduce(((e,t)=>{const r=e[e.length-1];return t.start=r?.end??0,t.end=t.start+t.raw.byteLength,e.concat(t)}),[]),this.sections=this.#g.map(((e,t)=>({id:t,load:()=>this.loadSection(e),createDocument:()=>this.createDocument(e),size:e.end-e.start})));const r=[];try{const e=await this.mobi.getNCX(),t=({label:e,offset:s,children:n})=>{const i=s.toString().padStart(10,"0"),a=`filepos:${i}`;return r.push(i),{label:e=unescapeHTML(e),href:a,subitems:n?.map(t)}};if(this.toc=e?.map(t),this.landmarks=await this.getGuide(),!this.toc){const e=this.landmarks.find((({type:e})=>e?.includes("toc")))?.href;if(e){const{index:t}=this.resolveHref(e),r=await this.sections[t].createDocument();this.toc=Array.from(r.querySelectorAll("a[filepos]"),(e=>({label:e.innerText?.trim(),href:`filepos:${e.getAttribute("filepos")}`})))}}}catch(e){console.warn(e)}return this.#f=[...new Set(r.concat(Array.from(t.matchAll(fileposRegex),(e=>e[1]))))].map((e=>({filepos:e,number:Number(e)}))).sort(((e,t)=>e.number-t.number)),this.metadata=this.mobi.getMetadata(),this.getCover=this.mobi.getCover.bind(this.mobi),this}async getGuide(){const e=await this.createDocument(this.#g[0]);return Array.from(e.getElementsByTagName("reference"),(e=>({label:e.getAttribute("title"),type:e.getAttribute("type")?.split(/\s/),href:`filepos:${e.getAttribute("filepos")}`})))}async loadResource(e){if(this.#h.has(e))return this.#h.get(e);const t=await this.mobi.loadResource(e),r=URL.createObjectURL(new Blob([t]));return this.#h.set(e,r),r}async loadRecindex(e){return this.loadResource(Number(e)-1)}async replaceResources(e){for(const t of e.querySelectorAll("img[recindex]")){const e=t.getAttribute("recindex");try{t.src=await this.loadRecindex(e)}catch(t){console.warn(`Failed to load image ${e}`)}}for(const t of e.querySelectorAll("[mediarecindex]")){const e=t.getAttribute("mediarecindex"),r=t.getAttribute("recindex");try{t.src=await this.loadRecindex(e),r&&(t.poster=await this.loadRecindex(r))}catch(t){console.warn(`Failed to load media ${e}`)}}for(const t of e.querySelectorAll("[filepos]")){const e=t.getAttribute("filepos");t.href=`filepos:${e}`}}async loadText(e){if(this.#u.has(e))return this.#u.get(e);const{raw:t}=e,r=this.#f.filter((({number:t})=>t>=e.start&&t<e.end)).map((t=>({...t,offset:t.number-e.start})));let s=t;r.length&&(s=t.subarray(0,r[0].offset),r.forEach((({filepos:e,offset:n},i)=>{const a=r[i+1],o=this.mobi.encode(`<a id="filepos${e}"></a>`);s=concatTypedArray3(s,o,t.subarray(n,a?.offset))})));const n=this.mobi.decode(s).replaceAll(mbpPagebreakRegex,"");return this.#u.set(e,n),n}async createDocument(e){const t=await this.loadText(e);return this.parser.parseFromString(t,this.#p)}async loadSection(e){if(this.#d.has(e))return this.#d.get(e);const t=await this.createDocument(e),r=t.createElement("style");t.head.append(r),r.append(t.createTextNode("blockquote {\n            margin-block-start: 0;\n            margin-block-end: 0;\n            margin-inline-start: 1em;\n            margin-inline-end: 0;\n        }")),await this.replaceResources(t);const s=this.serializer.serializeToString(t),n=URL.createObjectURL(new Blob([s],{type:this.#p}));return this.#d.set(e,n),n}resolveHref(e){const t=e.match(/filepos:(.*)/)[1],r=Number(t);return{index:this.#g.findIndex((e=>e.end>r)),anchor:e=>e.getElementById(`filepos${t}`)}}splitTOCHref(e){const t=e.match(/filepos:(.*)/)[1],r=Number(t);return[this.#g.findIndex((e=>e.end>r)),`filepos${t}`]}getTOCFragment(e,t){return e.getElementById(t)}isExternal(e){return/^(?!blob|filepos)\w+:/i.test(e)}destroy(){for(const e of this.#h.values())URL.revokeObjectURL(e);for(const e of this.#d.values())URL.revokeObjectURL(e)}}const kindleResourceRegex=/kindle:(flow|embed):(\w+)(?:\?mime=(\w+\/[-+.\w]+))?/,kindlePosRegex=/kindle:pos:fid:(\w+):off:(\w+)/,parseResourceURI=e=>{const[t,r,s]=e.match(kindleResourceRegex).slice(1);return{resourceType:t,id:parseInt(r,32),type:s}},parsePosURI=e=>{const[t,r]=e.match(kindlePosRegex).slice(1);return{fid:parseInt(t,32),off:parseInt(r,32)}},makePosURI=(e=0,t=0)=>`kindle:pos:fid:${e.toString(32).toUpperCase().padStart(4,"0")}:off:${t.toString(32).toUpperCase().padStart(10,"0")}`,getFragmentSelector=e=>{const t=e.match(/\s(id|name|aid)\s*=\s*['"]([^'"]*)['"]/i);if(!t)return;const[,r,s]=t;return`[${r}="${CSS.escape(s)}"]`},replaceSeries=async(e,t,r)=>{const s=[];e.replace(t,((...e)=>(s.push(e),null)));const n=[];for(const e of s)n.push(await r(...e));return e.replace(t,(()=>n.shift()))},getPageSpread=e=>{for(const t of e){if("page-spread-left"===t||"rendition:page-spread-left"===t)return"left";if("page-spread-right"===t||"rendition:page-spread-right"===t)return"right";if("rendition:page-spread-center"===t)return"center"}};class KF8{parser=new DOMParser;serializer=new XMLSerializer;#d=new Map;#m=new Map;#b=new Map;#w={};#g;#y;#R=new Uint8Array;#E=new Uint8Array;#S=-1;#x=-1;#p=MIME.XHTML;#T=new Map;constructor(e){this.mobi=e}async init(){const e=this.mobi.loadRecord.bind(this.mobi),{kf8:t}=this.mobi.headers;try{const r=await e(t.fdst),s=getStruct(FDST_HEADER,r);if("FDST"!==s.magic)throw new Error("Missing FDST record");const n=Array.from({length:s.numEntries},((e,t)=>12+8*t)).map((e=>[getUint(r.slice(e,e+4)),getUint(r.slice(e+4,e+8))]));this.#w.fdstTable=n,this.#y=n[n.length-1][1]}catch{}const r=(await getIndexData(t.skel,e)).table.map((({name:e,tagMap:t},r)=>({index:r,name:e,numFrag:t[1][0],offset:t[6][0],length:t[6][1]}))),s=await getIndexData(t.frag,e),n=s.table.map((({name:e,tagMap:t})=>({insertOffset:parseInt(e),selector:s.cncx[t[2][0]],index:t[4][0],offset:t[6][0],length:t[6][1]})));this.#w.skelTable=r,this.#w.fragTable=n,this.#g=r.reduce(((e,t)=>{const r=e[e.length-1],s=r?.fragEnd??0,i=s+t.numFrag,a=n.slice(s,i),o=t.length+a.map((e=>e.length)).reduce(((e,t)=>e+t)),c=(r?.totalLength??0)+o;return e.concat({skel:t,frags:a,fragEnd:i,length:o,totalLength:c})}),[]);const i=await this.getResourcesByMagic(["RESC","PAGE"]),a=new Map;if(i.RESC){const e=await this.mobi.loadRecord(i.RESC),t=this.mobi.decode(e.slice(16)).replace(/\0/g,""),r=t.search(/\?>/),s=`<package>${t.slice(r)}</package>`,n=this.parser.parseFromString(s,MIME.XML);for(const e of n.querySelectorAll("spine > itemref")){const t=parseInt(e.getAttribute("skelid"));a.set(t,getPageSpread(e.getAttribute("properties")?.split(" ")??[]))}}this.sections=this.#g.map(((e,t)=>e.frags.length?{id:t,load:()=>this.loadSection(e),createDocument:()=>this.createDocument(e),size:e.length,pageSpread:a.get(t)}:{linear:"no"}));try{const e=await this.mobi.getNCX(),t=({label:e,pos:r,children:s})=>{const[n,i]=r,a=makePosURI(n,i),o=this.#m.get(n);return o?o.push(i):this.#m.set(n,[i]),{label:unescapeHTML(e),href:a,subitems:s?.map(t)}};this.toc=e?.map(t),this.landmarks=await this.getGuide()}catch(e){console.warn(e)}const{exth:o}=this.mobi.headers;return this.dir=o.pageProgressionDirection,this.rendition={layout:"true"===o.fixedLayout?"pre-paginated":"reflowable",viewport:Object.fromEntries(o.originalResolution?.split("x")?.slice(0,2)?.map(((e,t)=>[t?"height":"width",e]))??[])},this.metadata=this.mobi.getMetadata(),this.getCover=this.mobi.getCover.bind(this.mobi),this}async getResourcesByMagic(e){const t={},r=this.mobi.headers.kf8.resourceStart,s=this.mobi.pdb.numRecords;for(let n=r;n<s;n++)try{const r=await this.mobi.loadMagic(n),s=e.find((e=>e===r));s&&(t[s]=n)}catch{}return t}async getGuide(){const e=this.mobi.headers.kf8.guide;if(e<4294967295){const t=this.mobi.loadRecord.bind(this.mobi),{table:r,cncx:s}=await getIndexData(e,t);return r.map((({name:e,tagMap:t})=>({label:s[t[1][0]]??"",type:e?.split(/\s/),href:makePosURI(t[6]?.[0]??t[3]?.[0])})))}}async loadResourceBlob(e){const{resourceType:t,id:r,type:s}=parseResourceURI(e),n="flow"===t?await this.loadFlow(r):await this.mobi.loadResource(r-1),i=[MIME.XHTML,MIME.HTML,MIME.CSS,MIME.SVG].includes(s)?await this.replaceResources(this.mobi.decode(n)):n,a=s===MIME.SVG?this.parser.parseFromString(i,s):null;return[new Blob([i],{type:s}),a?.getElementsByTagNameNS("http://www.w3.org/2000/svg","image")?.length?a.documentElement:null]}async loadResource(e){if(this.#d.has(e))return this.#d.get(e);const[t,r]=await this.loadResourceBlob(e),s=r?e:URL.createObjectURL(t);return r&&this.#T.set(s,r),this.#d.set(e,s),s}replaceResources(e){const t=new RegExp(kindleResourceRegex,"g");return replaceSeries(e,t,this.loadResource.bind(this))}async loadRaw(e,t){const r=t-this.#R.length,s=null==this.#y?1/0:this.#y-this.#E.length-e;if(r<0||r<s){for(;this.#R.length<t;){const e=++this.#S,t=await this.mobi.loadText(e);this.#R=concatTypedArray(this.#R,t)}return this.#R.slice(e,t)}for(;this.#y-this.#E.length>e;){const e=this.mobi.headers.palmdoc.numTextRecords-1-++this.#x,t=await this.mobi.loadText(e);this.#E=concatTypedArray(t,this.#E)}const n=this.#y-this.#E.length;return this.#E.slice(e-n,t-n)}loadFlow(e){if(e<4294967295)return this.loadRaw(...this.#w.fdstTable[e])}async loadText(e){const{skel:t,frags:r,length:s}=e,n=await this.loadRaw(t.offset,t.offset+s);let i=n.slice(0,t.length);for(const e of r){const r=e.insertOffset-t.offset,s=t.length+e.offset,a=n.slice(s,s+e.length);i=concatTypedArray3(i.slice(0,r),a,i.slice(r));const o=this.#m.get(e.index);if(o)for(const t of o){const r=this.mobi.decode(a).slice(t),s=getFragmentSelector(r);this.#A(e.index,t,s)}}return this.mobi.decode(i)}async createDocument(e){const t=await this.loadText(e);return this.parser.parseFromString(t,this.#p)}async loadSection(e){if(this.#d.has(e))return this.#d.get(e);const t=await this.loadText(e),r=await this.replaceResources(t);let s=this.parser.parseFromString(r,this.#p);s.querySelector("parsererror")&&(this.#p=MIME.HTML,s=this.parser.parseFromString(r,this.#p));for(const[e,t]of this.#T)for(const r of s.querySelectorAll(`img[src="${e}"]`))r.replaceWith(t);const n=URL.createObjectURL(new Blob([this.serializer.serializeToString(s)],{type:this.#p}));return this.#d.set(e,n),n}getIndexByFID(e){return this.#g.findIndex((t=>t.frags.some((t=>t.index===e))))}#A(e,t,r){const s=this.#b.get(e);if(s)s.set(t,r);else{const s=new Map;this.#b.set(e,s),s.set(t,r)}}async resolveHref(e){const{fid:t,off:r}=parsePosURI(e),s=this.getIndexByFID(t);if(s<0)return;const n=this.#b.get(t)?.get(r);if(n)return{index:s,anchor:e=>e.querySelector(n)};const{skel:i,frags:a}=this.#g[s],o=a.find((e=>e.index===t)),c=i.offset+i.length+o.offset,l=await this.loadRaw(c,c+o.length),h=this.mobi.decode(l).slice(r),u=getFragmentSelector(h);return this.#A(t,r,u),{index:s,anchor:e=>e.querySelector(u)}}splitTOCHref(e){const t=parsePosURI(e);return[this.getIndexByFID(t.fid),t]}getTOCFragment(e,{fid:t,off:r}){const s=this.#b.get(t)?.get(r);return e.querySelector(s)}isExternal(e){return/^(?!blob|kindle)\w+:/i.test(e)}destroy(){for(const e of this.#d.values())URL.revokeObjectURL(e)}}