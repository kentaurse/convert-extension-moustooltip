const normalizeWhitespace=e=>e?e.replace(/[\t\n\f\r ]+/g," ").replace(/^[\t\n\f\r ]+/,"").replace(/[\t\n\f\r ]+$/,""):"",getElementText=e=>normalizeWhitespace(e?.textContent),NS={XLINK:"http://www.w3.org/1999/xlink",EPUB:"http://www.idpf.org/2007/ops"},MIME={XML:"application/xml",XHTML:"application/xhtml+xml"},STYLE={strong:["strong","self"],emphasis:["em","self"],style:["span","self"],a:"anchor",strikethrough:["s","self"],sub:["sub","self"],sup:["sup","self"],code:["code","self"],image:"image"},TABLE={tr:["tr",["align"]],th:["th",["colspan","rowspan","align","valign"]],td:["td",["colspan","rowspan","align","valign"]]},POEM={epigraph:["blockquote"],subtitle:["h2",STYLE],"text-author":["p",STYLE],date:["p",STYLE],stanza:"stanza"},SECTION={title:["header",{p:["h1",STYLE],"empty-line":["br"]}],epigraph:["blockquote","self"],image:"image",annotation:["aside"],section:["section","self"],p:["p",STYLE],poem:["blockquote",POEM],subtitle:["h2",STYLE],cite:["blockquote","self"],"empty-line":["br"],table:["table",TABLE],"text-author":["p",STYLE]};POEM.epigraph.push(SECTION);const BODY={image:"image",title:["section",{p:["h1",STYLE],"empty-line":["br"]}],epigraph:["section",SECTION],section:["section",SECTION]},getImageSrc=e=>{const t=e.getAttributeNS(NS.XLINK,"href"),[,n]=t.split("#"),r=e.getRootNode().getElementById(n);return r?`data:${r.getAttribute("content-type")};base64,${r.textContent}`:t};class FB2Converter{constructor(e){this.fb2=e,this.doc=document.implementation.createDocument(NS.XHTML,"html")}image(e){const t=this.doc.createElement("img");return t.alt=e.getAttribute("alt"),t.title=e.getAttribute("title"),t.setAttribute("src",getImageSrc(e)),t}anchor(e){const t=this.convert(e,{a:["a",STYLE]});return t.setAttribute("href",e.getAttributeNS(NS.XLINK,"href")),"note"===e.getAttribute("type")&&t.setAttributeNS(NS.EPUB,"epub:type","noteref"),t}stanza(e){const t=this.convert(e,{stanza:["p",{title:["header",{p:["strong",STYLE],"empty-line":["br"]}],subtitle:["p",STYLE]}]});for(const n of e.children)"v"===n.nodeName&&(t.append(this.doc.createTextNode(n.textContent)),t.append(this.doc.createElement("br")));return t}convert(e,t){if(3===e.nodeType)return this.doc.createTextNode(e.textContent);if(4===e.nodeType)return this.doc.createCDATASection(e.textContent);if(8===e.nodeType)return this.doc.createComment(e.textContent);const n=t?.[e.nodeName];if(!n)return null;if("string"==typeof n)return this[n](e);const[r,o]=n,i=this.doc.createElement(r);if(e.id&&(i.id=e.id),i.classList.add(e.nodeName),Array.isArray(o))for(const t of o)i.setAttribute(t,e.getAttribute(t));const a="self"===o?t:Array.isArray(o)?null:o;let l=e.firstChild;for(;l;){const e=this.convert(l,a);e&&i.append(e),l=l.nextSibling}return i}}const parseXML=async e=>{const t=await e.arrayBuffer(),n=new TextDecoder("utf-8").decode(t),r=new DOMParser,o=r.parseFromString(n,MIME.XML),i=o.xmlEncoding||n.match(/^<\?xml\s+version\s*=\s*["']1.\d+"\s+encoding\s*=\s*["']([A-Za-z0-9._-]*)["']/)?.[1];if(i&&"utf-8"!==i.toLowerCase()){const e=new TextDecoder(i).decode(t);return r.parseFromString(e,MIME.XML)}return o},style=URL.createObjectURL(new Blob(['\n@namespace epub "http://www.idpf.org/2007/ops";\nbody > img, section > img {\n    display: block;\n    margin: auto;\n}\n.title h1 {\n    text-align: center;\n}\nbody > section > .title, body.notesBodyType > .title {\n    margin: 3em 0;\n}\nbody.notesBodyType > section .title h1 {\n    text-align: start;\n}\nbody.notesBodyType > section .title {\n    margin: 1em 0;\n}\np {\n    text-indent: 1em;\n    margin: 0;\n}\n:not(p) + p, p:first-child {\n    text-indent: 0;\n}\n.poem p {\n    text-indent: 0;\n    margin: 1em 0;\n}\n.text-author, .date {\n    text-align: end;\n}\n.text-author:before {\n    content: "â€”";\n}\ntable {\n    border-collapse: collapse;\n}\ntd, th {\n    padding: .25em;\n}\na[epub|type~="noteref"] {\n    font-size: .75em;\n    vertical-align: super;\n}\nbody:not(.notesBodyType) > .title, body:not(.notesBodyType) > .epigraph {\n    margin: 3em 0;\n}\n'],{type:"text/css"})),template=e=>`<?xml version="1.0" encoding="utf-8"?>\n<html xmlns="http://www.w3.org/1999/xhtml">\n    <head><link href="${style}" rel="stylesheet" type="text/css"/></head>\n    <body>${e}</body>\n</html>`,dataID="data-foliate-id";export const makeFB2=async e=>{const t={},n=await parseXML(e),r=new FB2Converter(n),o=e=>n.querySelector(e),i=e=>[...n.querySelectorAll(e)],a=e=>{const t=getElementText(e.querySelector("nickname"));if(t)return t;const n=getElementText(e.querySelector("first-name")),r=getElementText(e.querySelector("middle-name")),o=getElementText(e.querySelector("last-name"));return{name:[n,r,o].filter((e=>e)).join(" "),sortAs:o?[o,[n,r].filter((e=>e)).join(" ")].join(", "):null}},l=e=>e?.getAttribute("value")??getElementText(e),s=o("title-info annotation");if(t.metadata={title:getElementText(o("title-info book-title")),identifier:getElementText(o("document-info id")),language:getElementText(o("title-info lang")),author:i("title-info author").map(a),translator:i("title-info translator").map(a),producer:i("document-info author").map(a).concat(i("document-info program-used").map(getElementText)),publisher:getElementText(o("publish-info publisher")),published:l(o("title-info date")),modified:l(o("document-info date")),description:s?r.convert(s,{annotation:["div",SECTION]}).innerHTML:null,subject:i("title-info genre").map(getElementText)},o("coverpage image")){const e=getImageSrc(o("coverpage image"));t.getCover=()=>fetch(e).then((e=>e.blob()))}else t.getCover=()=>null;const c=Array.from(n.querySelectorAll("body"),(e=>{const t=r.convert(e,{body:["body",BODY]});return[Array.from(t.children,(e=>{const t=[e,...e.querySelectorAll("[id]")].map((e=>e.id));return{el:e,ids:t}})),t]})),d=[],p=c[0][0].map((({el:e,ids:t})=>({ids:t,titles:Array.from(e.querySelectorAll(":scope > section > .title"),((e,t)=>(e.setAttribute(dataID,t),{title:getElementText(e),index:t}))),el:e}))).concat(c.slice(1).map((([e,t])=>{const n=e.map((e=>e.ids)).flat();return t.classList.add("notesBodyType"),{ids:n,el:t,linear:"no"}}))).map((({ids:e,titles:t,el:n,linear:r})=>{const o=(i=n.outerHTML,`<?xml version="1.0" encoding="utf-8"?>\n<html xmlns="http://www.w3.org/1999/xhtml">\n    <head><link href="${style}" rel="stylesheet" type="text/css"/></head>\n    <body>${i}</body>\n</html>`);var i;const a=new Blob([o],{type:MIME.XHTML}),l=URL.createObjectURL(a);return d.push(l),{ids:e,title:normalizeWhitespace(n.querySelector(".title, .subtitle, p")?.textContent??(n.classList.contains("title")?n.textContent:"")),titles:t,load:()=>l,createDocument:()=>(new DOMParser).parseFromString(o,MIME.XHTML),size:a.size-Array.from(n.querySelectorAll("[src]"),(e=>e.getAttribute("src")?.length??0)).reduce(((e,t)=>e+t),0),linear:r}})),m=new Map;return t.sections=p.map(((e,t)=>{const{ids:n,load:r,createDocument:o,size:i,linear:a}=e;for(const e of n)e&&m.set(e,t);return{id:t,load:r,createDocument:o,size:i,linear:a}})),t.toc=p.map((({title:e,titles:t},n)=>{const r=n.toString();return{label:e,href:r,subitems:t?.length?t.map((({title:e,index:t})=>({label:e,href:`${r}#${t}`}))):null}})).filter((e=>e)),t.resolveHref=e=>{const[t,n]=e.split("#");return t?{index:Number(t),anchor:e=>e.querySelector(`[${dataID}="${n}"]`)}:{index:m.get(n),anchor:e=>e.getElementById(n)}},t.splitTOCHref=e=>e?.split("#")?.map((e=>Number(e)))??[],t.getTOCFragment=(e,t)=>e.querySelector(`[${dataID}="${t}"]`),t.destroy=()=>{for(const e of d)URL.revokeObjectURL(e)},t};