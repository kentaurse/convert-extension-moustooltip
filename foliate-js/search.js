const CONTEXT_LENGTH=50,normalizeWhitespace=e=>e.replace(/\s+/g," "),makeExcerpt=(e,{startIndex:t,startOffset:n,endIndex:s,endOffset:r})=>{const a=e[t],c=e[s],i=a===c?a.slice(n,r):a.slice(n)+e.slice(a+1,c).join("")+c.slice(0,r),o=normalizeWhitespace(a.slice(0,n)).trimStart(),l=normalizeWhitespace(c.slice(r)).trimEnd(),g=o.length<50?"":"…",h=l.length<50?"":"…";return{pre:`${g}${o.slice(-50)}`,match:i,post:`${l.slice(0,50)}${h}`}},simpleSearch=function*(e,t,n={}){const{locales:s="en",sensitivity:r}=n,a="variant"===r,c=e.join(""),i=a?c:c.toLocaleLowerCase(s),o=a?t:t.toLocaleLowerCase(s),l=o.length;let g=-1,h=-1,m=0;do{if(g=i.indexOf(o,g+1),g>-1){for(;m<=g;)m+=e[++h].length;const t=h,n=g-(m-e[h].length),s=g+l;for(;m<=s;)m+=e[++h].length;const r={startIndex:t,startOffset:n,endIndex:h,endOffset:s-(m-e[h].length)};yield{range:r,excerpt:makeExcerpt(e,r)}}}while(g>-1)},segmenterSearch=function*(e,t,n={}){const{locales:s="en",granularity:r="word",sensitivity:a="base"}=n;let c,i;try{c=new Intl.Segmenter(s,{usage:"search",granularity:r}),i=new Intl.Collator(s,{sensitivity:a})}catch(e){console.warn(e),c=new Intl.Segmenter("en",{usage:"search",granularity:r}),i=new Intl.Collator("en",{sensitivity:a})}const o=Array.from(c.segment(t)).length,l=[];let g=0,h=c.segment(e[g])[Symbol.iterator]();e:for(;g<e.length;){for(;l.length<o;){const{done:t,value:n}=h.next();if(t){if(g++,g<e.length){h=c.segment(e[g])[Symbol.iterator]();continue}break e}const{index:s,segment:r}=n;/[^\p{Format}]/u.test(r)&&(/\s/u.test(r)?/\s/u.test(l[l.length-1]?.segment)||l.push({strIndex:g,index:s,segment:" "}):(n.strIndex=g,l.push(n)))}const n=l.map((e=>e.segment)).join("");if(0===i.compare(t,n)){const t=g,n=l[l.length-1],s=n.index+n.segment.length,r={startIndex:l[0].strIndex,startOffset:l[0].index,endIndex:t,endOffset:s};yield{range:r,excerpt:makeExcerpt(e,r)}}l.shift()}};export const search=(e,t,n)=>{const{granularity:s="grapheme",sensitivity:r="base"}=n;return Intl?.Segmenter&&("grapheme"!==s||"variant"!==r&&"accent"!==r)?segmenterSearch(e,t,n):simpleSearch(e,t,n)};export const searchMatcher=(e,t)=>{const{defalutLocale:n,matchCase:s,matchDiacritics:r,matchWholeWords:a}=t;return function*(t,c){const i=e(t,(function*(e,i){for(const o of search(e,c,{locales:t.body.lang||t.documentElement.lang||n||"en",granularity:a?"word":"grapheme",sensitivity:r&&s?"variant":r&&!s?"accent":!r&&s?"case":"base"})){const{startIndex:e,startOffset:t,endIndex:n,endOffset:s}=o.range;o.range=i(e,t,n,s),yield o}}));for(const e of i)yield e}};