async function doqInit(){let e=new URL(import.meta.url).pathname;e=e.substring(0,e.lastIndexOf("/")+1);const t=await fetch(e+"colors.json").then((e=>e.json()));!function(e){const t=document.createElement("link");t.rel="stylesheet",t.href=e,document.head.appendChild(t)}(e+"doq.css"),fetch(e+"doq.html").then((e=>e.text())).then((function(e){const t=document.createRange().createContextualFragment(e);document.getElementById("toolbarViewerRight").prepend(t.getElementById("toolbarAddon").content),document.getElementById("findbar").after(t.getElementById("mainAddon").content)})).then((()=>{DOQReader.load(t)}))}"interactive"===document.readyState||"complete"===document.readyState?doqInit():document.addEventListener("DOMContentLoaded",doqInit,!0);import{Color}from"./lib/color.js";const newColor=e=>new Color(e),DOQReader={config:{},preferences:{},colorSchemes:[],readerTone:{},canvasData:new WeakMap,styleCache:new Map,options:{autoReader:!0,dynamicTheme:!0},flags:{readerOn:!1,isPrinting:!1},getDefaultPrefs:()=>({scheme:0,tone:"0",flags:{shapesOn:!0,imagesOn:!0}}),getDoqConfig:()=>({sysTheme:window.matchMedia("(prefers-color-scheme: light)"),docStyle:document.documentElement.style,viewReader:document.getElementById("viewReader"),readerToolbar:document.getElementById("readerToolbar"),schemeSelector:document.getElementById("schemeSelect"),tonePicker:document.getElementById("tonePicker"),shapeToggle:document.getElementById("shapeEnable"),imageToggle:document.getElementById("imageEnable"),optionsToggle:document.getElementById("optionsToggle"),viewerClassList:document.getElementById("outerContainer").classList,viewer:document.getElementById("viewerContainer")}),load(e){this.config=this.getDoqConfig(),e.forEach((e=>{this.config.schemeSelector.innerHTML+=`<option>${e.name}</option>`,e.tones.forEach((t=>{const[n,s]=[t.background,t.foreground].map(newColor);t.colors={bg:n,fg:s,grad:n.range(s),acc:(t.accents||[]).map(newColor)},t.scheme=e})),e.colors=(e.accents||[]).map(newColor)})),this.colorSchemes=e,this.updateReaderState();const t=pdfjsLib.version.split(".").map(Number);t[0]<3&&((t[0]<2||t[1]<7)&&console.warn("doq: unsupported PDF.js version "+pdfjsLib.version),this.config.viewReader.classList.add("pdfjsLegacy"),this.config.readerToolbar.classList.add("pdfjsLegacy")),this.config.sysTheme.onchange=this.updateReaderState.bind(this),this.config.schemeSelector.onchange=this.updateColorScheme.bind(this),this.config.tonePicker.onchange=this.updateReaderColors.bind(this),this.config.viewReader.onclick=this.toggleToolbar.bind(this),this.config.shapeToggle.onchange=this.config.imageToggle.onchange=this.toggleFlags.bind(this),this.config.optionsToggle.onchange=e=>this.toggleOptions(),this.config.schemeSelector.onclick=e=>{this.config.readerToolbar.classList.remove("tabMode")},this.config.viewer.addEventListener("input",this.handleInput.bind(this)),window.addEventListener("beforeprint",(e=>this.flags.isPrinting=!0)),window.addEventListener("afterprint",(e=>this.flags.isPrinting=!1)),window.addEventListener("click",this.closeToolbar.bind(this)),window.addEventListener("keydown",this.handleKeyDown.bind(this)),window.addEventListener("resize",this.updateToolbarPos.bind(this)),new MutationObserver(this.updateToolbarPos.bind(this)).observe(this.config.viewReader.parentElement,{subtree:!0,attributeFilter:["style","class","hidden"]});const n=window.PDFViewerApplication,s=()=>{n.initializedPromise.then((()=>{n.eventBus.on("switchannotationeditorparams",this.recolorSelectedAnnots.bind(this))}))};n.initializedPromise?s():document.addEventListener("webviewerloaded",s.bind(this));const o=CanvasRenderingContext2D.prototype,i=this.checkFlags.bind(this),a=this.forgetCanvas.bind(this);o.origFillRect=o.fillRect,["fill","stroke"].forEach((e=>{["","Rect","Text"].forEach((t=>{o[e+t]=this.wrap(o[e+t],this.setReaderStyle.bind(this),i,"Text"!==t?a:null,e+"Style")}))})),o.origDrawImage=o.drawImage,o.drawImage=this.wrap(o.drawImage,this.setReaderCompOp.bind(this),i,a)},wrap:(e,t,n,s,o)=>function(){if(!n?.())return e.apply(this,arguments);this.save(),t(this,e,arguments,o);const i=e.apply(this,arguments);return this.restore(),s?.(this),i},checkFlags(){return this.flags.readerOn&&!this.flags.isPrinting},saveCanvas(e){const t=e.canvas;return!(!t.isConnected||!t.closest(".canvasWrapper")||(this.canvasData.set(e,e.getImageData(0,0,t.width,t.height)),0))},forgetCanvas(e){this.canvasData.delete(e)},setReaderStyle(e,t,n,s){const o=e[s];if("string"!=typeof o)return;const i=t.name.endsWith("Text");if(!(i||"fillRect"===t.name&&n[2]==e.canvas.width&&n[3]==e.canvas.height||this.flags.shapesOn))return;const a=i&&this.getCanvasColor(e,...n);e[s]=this.getReaderStyle(o,a)},getReaderStyle(e,t){const n=(e=newColor(e)).hex+(t?.hex||"");let s=this.styleCache.get(n);return s||(s=this.calcStyle(e,t),this.styleCache.set(n,s)),s.toHex(e.alpha)},getCanvasColor(e,t,n,s){if(!this.canvasData.has(e)&&!this.saveCanvas(e))return null;const o=e.measureText(t),i=o.width/2,a=(o.actualBoundingBoxAscent-o.actualBoundingBoxDescent)/2,r=e.getTransform();let{x:c,y:l}=r.transformPoint({x:n+i,y:s-a});[c,l]=[c,l].map(Math.round);const d=this.canvasData.get(e),h=4*(l*d.width+c),g=Array.from(d.data.slice(h,h+3));return newColor(g.map((e=>e/255)))},calcStyle(e,t){const{bg:n,fg:s,grad:o,acc:i}=this.readerTone.colors;let a;if(e.chroma>10){const t=i.concat(this.readerTone.scheme.colors);t.length&&(a=this.findMatch(t,(t=>t.deltaE(e)),Math.min))}else if(t&&n.deltaE(t)>2.3)a=this.findMatch([n,s],(e=>Math.abs(e.lightness-t.lightness)),Math.max);else{const t=Color.white.lightness;a=o(1-e.lightness/t)}return a},findMatch(e,t,n){const s=e.map(t);return e[s.indexOf(n(...s))]},setReaderCompOp(e,t,n){if(!this.flags.imagesOn||!e.canvas.isConnected)return;const s=this.readerTone;if(s.colors.bg.lightness<50&&n.length>=5){n=[...n];const o=this.createMask(s.foreground,n.slice(0,5));n.splice(0,1,o),t.apply(e,n)}e.globalCompositeOperation="multiply"},createMask(e,t){const n=document.createElement("canvas"),s=[n.width,n.height]=t.slice(3),o=n.getContext("2d");return o.fillStyle=e,o.origFillRect(0,0,...s),o.globalCompositeOperation="destination-in",o.origDrawImage(...t,0,0,...s),n},readPreferences(){let e=this.getDefaultPrefs();const t=this.getSysTheme(),n=JSON.parse(localStorage.getItem(`doq.preferences.${t}`));for(const t in n){const s=n[t];t in e&&typeof s==typeof e[t]&&(e[t]=s)}return this.preferences=e,e},updatePreference(e,t){let n=this.preferences;const s=this.getSysTheme();e in n.flags?n.flags[e]=this.flags[e]:e in n&&typeof t==typeof n[e]&&(n[e]=t),localStorage.setItem(`doq.preferences.${s}`,JSON.stringify(n))},getSysTheme(){return!this.options.dynamicTheme||this.config.sysTheme.matches?"light":"dark"},updateReaderState(e){this.readOptions();const t=this.readPreferences();Object.assign(this.flags,t.flags),this.config.imageToggle.checked=t.flags.imagesOn,this.config.shapeToggle.checked=t.flags.shapesOn,this.config.schemeSelector.selectedIndex=t.scheme,e&&!this.options.dynamicTheme||this.updateColorScheme(e),this.updateToolbarPos()},readOptions(){const e=JSON.parse(localStorage.getItem("doq.options"));for(const t in this.options)typeof this.options[t]==typeof e?.[t]&&(this.options[t]=e[t])},updateColorScheme(e){const t=this.config.schemeSelector.selectedIndex,n=this.colorSchemes[t];if(!n.tones||!n.tones.length)return;n.tones.length>3&&console.warn("doq: can show up to three tones only; ignoring the rest.");const s=this.config.tonePicker,o=s.querySelector("template");let i=0;s.innerHTML=o.outerHTML,s.appendChild(this.cloneWidget(o,"origTone","Original",i++)),n.tones.slice(0,3).forEach((e=>{s.appendChild(this.cloneWidget(o,null,null,i++,e))})),s.appendChild(this.cloneWidget(o,"invertTone","Invert",i)),s.lastElementChild.classList.add("invert"),t!==this.preferences.scheme&&(this.updatePreference("scheme",t),this.updatePreference("tone","1"));const a=e||this.options.autoReader?this.preferences.tone:0;s.elements[a].checked=!0,this.updateReaderColors(e)},cloneWidget(e,t,n,s,o){const i=e.content.cloneNode(!0),[a,r]=i.children;return n=n||o?.name,a.value=s,a.id=r.htmlFor=t||"tone"+n,a.setAttribute("aria-label",n),r.title=n,r.style.color=o?.foreground,r.style.backgroundColor=o?.background,i},updateReaderColors(e){const t=this.config.tonePicker,n=t.readerTone.value,s=this.config.schemeSelector.selectedIndex,o=e?.isTrusted;0==n?(this.disableReader(o),this.disableInvert()):n==t.elements.length-1?this.enableInvert(o):(this.readerTone=this.colorSchemes[s].tones[+n-1],this.config.docStyle.setProperty("--reader-bg",this.readerTone.background),this.disableInvert(),this.enableReader(o)),this.updatePreference("tone",n)},forceRedraw(){const{pdfViewer:e,pdfThumbnailViewer:t}=window.PDFViewerApplication,n=e.pdfDocument?.annotationStorage.getAll();this.styleCache.clear(),this.canvasData=new WeakMap,Object.values(n||{}).forEach((e=>{"freeTextEditor"===e.name?this.recolorFreeTextAnnot(e.editorDiv):e.rebuild()})),e._pages.filter((e=>e.renderingState)).forEach((e=>e.reset())),t._thumbnails.filter((e=>e.renderingState)).forEach((e=>e.reset())),window.PDFViewerApplication.forceRendering()},enableReader(e){this.config.viewerClassList.add("reader"),this.flags.readerOn=!0,e&&this.forceRedraw()},disableReader(e){this.flags.readerOn&&(this.config.viewerClassList.remove("reader"),this.flags.readerOn=!1,e&&this.forceRedraw())},enableInvert(e){this.flags.readerOn&&this.disableReader(e),this.config.viewerClassList.add("invert")},disableInvert(){this.config.viewerClassList.remove("invert")},recolorSelectedAnnots(e){this.checkFlags()&&e.type===pdfjsLib.AnnotationEditorParamsType.FREETEXT_COLOR&&document.querySelectorAll(".freeTextEditor.selectedEditor > .internal").forEach((e=>this.recolorFreeTextAnnot(e)))},recolorFreeTextAnnot(e){const t=this.getReaderStyle(e.style.color);e.style.getPropertyValue("--free-text-color")!==t&&e.style.setProperty("--free-text-color",t)},toggleToolbar(){const e=this.config.readerToolbar.classList.toggle("hidden");this.config.viewReader.classList.toggle("toggled"),this.config.viewReader.setAttribute("aria-expanded",!e),e&&this.toggleOptions(!0)},toggleOptions(e){const t=this.config.readerToolbar.querySelector(".optionsPanel").classList.toggle("collapsed",e);this.config.optionsToggle.checked=!t},toggleFlags(e){const t=e.target.id.replace("Enable","sOn");this.flags[t]=e.target.checked,this.updatePreference(t),this.flags.readerOn&&this.forceRedraw()},handleInput(e){if(!this.checkFlags())return;const{target:t}=e,n=t.matches?.(".freeTextEditor > .internal");n&&!t.style.getPropertyValue("--free-text-color")&&this.recolorFreeTextAnnot(t)},handleKeyDown(e){"Tab"===e.code?this.config.readerToolbar.classList.add("tabMode"):"Escape"===e.code&&(this.closeToolbar(),e.target.blur(),e.preventDefault())},closeToolbar(e){const t=this.config.readerToolbar;t.contains(e?.target)||e?.target===this.config.viewReader||t.classList.contains("hidden")||this.toggleToolbar()},updateToolbarPos(){const e=document.documentElement.clientWidth,t=this.config.viewReader.getBoundingClientRect().right,n=e-Math.ceil(window.pageXOffset+t);this.config.readerToolbar.style.right=`${n+2}px`}};