const parseViewport=t=>t?.split(/[,;\s]/)?.filter((t=>t))?.map((t=>t.split("=").map((t=>t.trim())))),getViewport=(t,e)=>{if("svg"===t.documentElement.nodeName){const[,,e,i]=t.documentElement.getAttribute("viewBox")?.split(/\s/)??[];return{width:e,height:i}}const i=parseViewport(t.querySelector('meta[name="viewport"]')?.getAttribute("content"));if(i)return Object.fromEntries(i);if("string"==typeof e)return parseViewport(e);if(e)return e;const r=t.querySelector("img");return r?{width:r.naturalWidth,height:r.naturalHeight}:(console.warn(new Error("Missing viewport properties")),{width:1e3,height:2e3})};export class FixedLayout extends HTMLElement{#t=this.attachShadow({mode:"closed"});#e=new ResizeObserver((()=>this.#i()));#r;#s=-1;defaultViewport;spread;#n=!1;#o;#h;#a;#l;constructor(){super();const t=new CSSStyleSheet;this.#t.adoptedStyleSheets=[t],t.replaceSync(":host {\n            width: 100%;\n            height: 100%;\n            display: flex;\n            justify-content: center;\n            align-items: center;\n        }"),this.#e.observe(this)}async#d({index:t,src:e}){const i=document.createElement("div"),r=document.createElement("iframe");return i.append(r),Object.assign(r.style,{border:"0",display:"none",overflow:"hidden"}),r.setAttribute("sandbox","allow-same-origin allow-scripts"),r.setAttribute("scrolling","no"),r.setAttribute("part","filter"),this.#t.append(i),e?new Promise((s=>{const n=()=>{r.removeEventListener("load",n);const e=r.contentDocument;this.dispatchEvent(new CustomEvent("load",{detail:{doc:e,index:t}}));const{width:o,height:h}=getViewport(e,this.defaultViewport);s({element:i,iframe:r,width:parseFloat(o),height:parseFloat(h)})};r.addEventListener("load",n),r.src=e})):{blank:!0,element:i,iframe:r}}#i(t=this.#l){if(!t)return;const e=this.#o??{},i=this.#a??this.#h,r="left"===t?e:i,{width:s,height:n}=this.getBoundingClientRect(),o="both"!==this.spread&&"portrait"!==this.spread&&n>s;this.#n=o;const h=e.width??i.width,a=e.height??i.height,l=o||this.#a?Math.min(s/(r.width??h),n/(r.height??a)):Math.min(s/((e.width??h)+(i.width??h)),n/Math.max(e.height??a,i.height??a)),d=t=>{const{element:e,iframe:i,width:s,height:n,blank:d}=t;Object.assign(i.style,{width:`${s}px`,height:`${n}px`,transform:`scale(${l})`,transformOrigin:"top left",display:d?"none":"block"}),Object.assign(e.style,{width:(s??h)*l+"px",height:(n??a)*l+"px",overflow:"hidden",display:"block"}),o&&t!==r&&(e.style.display="none")};this.#a?d(this.#a):(d(e),d(i))}async#c({left:t,right:e,center:i,side:r}){this.#t.replaceChildren(),this.#o=null,this.#h=null,this.#a=null,i?(this.#a=await this.#d(i),this.#l="center",this.#i()):(this.#o=await this.#d(t),this.#h=await this.#d(e),this.#l=this.#o.blank?"right":this.#h.blank?"left":r,this.#i())}#p(){if(!this.#a&&!this.#o?.blank)return this.#n&&"none"===this.#o?.element?.style?.display?(this.#h.element.style.display="none",this.#o.element.style.display="block",this.#l="left",!0):void 0}#g(){if(!this.#a&&!this.#h?.blank)return this.#n&&"none"===this.#h?.element?.style?.display?(this.#o.element.style.display="none",this.#h.element.style.display="block",this.#l="right",!0):void 0}open(t){this.book=t;const{rendition:e}=t;this.spread=e?.spread,this.defaultViewport=e?.viewport;const i="rtl"===t.dir,r=!i;this.rtl=i,this.#r="none"===e?.spread?t.sections.map((t=>({center:t}))):t.sections.reduce(((t,e)=>{const s=t[t.length-1],{linear:n,pageSpread:o}=e;if("no"===n)return t;const h=()=>{const e={};return t.push(e),e};return"center"===o?(s.left||s.right?h():s).center=e:"left"===o?(s.center||s.left||r?h():s).left=e:"right"===o?(s.center||s.right||i?h():s).right=e:r?s.center||s.right?h().left=e:s.left?s.right=e:s.left=e:s.center||s.left?h().right=e:s.right?s.left=e:s.right=e,t}),[{}])}get index(){const t=this.#r[this.#s],e=t?.center??("left"===this.side?t.left??t.right:t.right??t.left);return this.book.sections.indexOf(e)}#f(t){this.dispatchEvent(new CustomEvent("relocate",{detail:{reason:t,range:null,index:this.index,fraction:0,size:1}}))}getSpreadOf(t){const e=this.#r;for(let i=0;i<e.length;i++){const{left:r,right:s,center:n}=e[i];if(r===t)return{index:i,side:"left"};if(s===t)return{index:i,side:"right"};if(n===t)return{index:i,side:"center"}}}async goToSpread(t,e,i){if(t<0||t>this.#r.length-1)return;if(t===this.#s)return void this.#i(e);this.#s=t;const r=this.#r[t];if(r.center){const t=this.book.sections.indexOf(r.center),e=await(r.center?.load?.());await this.#c({center:{index:t,src:e}})}else{const t=this.book.sections.indexOf(r.left),i=this.book.sections.indexOf(r.right),s={index:t,src:await(r.left?.load?.())},n={index:i,src:await(r.right?.load?.())};await this.#c({left:s,right:n,side:e})}this.#f(i)}async select(t){await this.goTo(t)}async goTo(t){const{book:e}=this,i=await t,r=e.sections[i.index];if(!r)return;const{index:s,side:n}=this.getSpreadOf(r);await this.goToSpread(s,n)}async next(){if(!(this.rtl?this.#p():this.#g()))return this.goToSpread(this.#s+1,this.rtl?"right":"left","page");this.#f("page")}async prev(){if(!(this.rtl?this.#g():this.#p()))return this.goToSpread(this.#s-1,this.rtl?"left":"right","page");this.#f("page")}getContents(){return Array.from(this.#t.querySelectorAll("iframe"),(t=>({doc:t.contentDocument})))}destroy(){this.#e.unobserve(this)}}customElements.define("foliate-fxl",FixedLayout);